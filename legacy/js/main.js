/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 * This Source Code Form is "Incompatible With Secondary Licenses", as
 * defined by the Mozilla Public License, v. 2.0.
 */
(()=>{"use strict";const e={locale:"en",title:"tReader",titleWithName:"{0} - tReader",listFilterClear:"Clear Search",listSortTitle:"Sort by",listSortByDateRead:"Date Read",listSortByDateAdd:"Date Add",listSortByTitle:"Title",listSortCancel:"Cancel",listImportTip:"Reading text file...",listNotYetRead:"NEW",listSearchPlaceholder:"Search",listEmptySearchTip:"Cannot find files match searching",listEmptyTip:"Tap the add mark import files",readContentsTemplate:"Template",readContentsTemplateDescription:"Template for the table of content: Use asterisk (*) for wildcard",readContentsTemplateHistory:"Recent",readContentsTemplateSubmit:"Build",readContentsTemplateClear:"Clear Recent",readContentsEmpty:"No table of contents yet.\nYou may click refresh button to build one.",readBookmarkEmpty:"No bookmarks yet.\nYou may click add bookmark button to add one.",readSearchPlaceholder:"Search",readSearchInitial:"Input some words so you can find them in text...",readSearchEmpty:'Cannot find "{0}"',readSearchTooMany:"{0} results found; Find More",readPagePrevious:"Previous Page",readPageNext:"Next Page",readPageScrollUp:"Scroll Up",readPageScrollDown:"Scroll Down",readControlClose:"Hide buttons",readAutoScrollStop:"Stop auto scroll",configPageTitle:"Settings",configWithDetail:"Detail",configModeGroupTitle:"Mode",configMode:"View Mode",configModeFlip:"Flip",configModeScroll:"Scroll",configThemeGroupTitle:"Theme",configTheme:"Theme",configThemeAuto:"Auto",configThemeLight:"Light",configThemeDark:"Dark",configDarkThemeGroupTitle:"Dark Theme",configDarkThemeColor:"Reader Text",configDarkThemeBackground:"Reader Background",configLightThemeGroupTitle:"Light Theme",configLightThemeColor:"Reader Text",configLightThemeBackground:"Reader Background",configTextGroupTitle:"Reader Text",configTextFontFamily:"Font Family",configTextFontFamilyUpload:"Select Font File",configTextFontFamilyDefault:"Default Font",configTextFontFamilyCustom:"Custom Font",configTextFontSize:"Font Size",configTextFontSizeNum:"{0}",configTextLineHeight:"Line Height",configTextLineHeightNum:"{0}",configTextParagraphSpacing:"Paragraph Spacing",configTextParagraphSpacingNum:"{0} lines",configTextLangTag:"Language Tag",configTextLangTagTitle:"Lang",configTextLangTagDescription:"This language tag will be used to render text content. This may cause different behavior of line breaking, and Han character rendering.",configPreprocessGroupTitle:"Preprocess",configPreprocessMultipleNewLine:"Max New Lines",configPreprocessMultipleNewLineNum:"Up to {0}",configPreprocessMultipleNewLineDisable:"Not Limited",configPreprocessChineseConvert:"Han Convert",configPreprocessChineseConvertS2T:"Simp. To Trad.",configPreprocessChineseConvertT2S:"Trad. To Simp.",configPreprocessChineseConvertDisabled:"Not Applied",configSpeechGroupTitle:"Speech",configSpeechVoice:"Voice",configSpeechVoiceRemote:"(Remote)",configSpeechVoiceEmpty:"No available speech voice detected.",configSpeechPitch:"Speech Pitch",configSpeechPitchNum:e=>0===e?"0 (lowest)":2===e?"2 (highest)":1===e?"1 (default)":String(e),configSpeechRate:"Speech Rate",configSpeechRateNum:e=>1===e?"1× (normal)":e+"×",configHelpGroupTitle:"Help",configHelpTopic:"Help",configHelpFilename:"en.html",configHelpCredits:"Open Source Credits",configHelpAbout:"About",configExpertGroupTitle:"Expert",configExpert:"Expert Config",configExpertDescription:"Please leave blank if you don't know what you are doing. Options misconfigured may lead the reader to stop working.",buttonRemove:"Remove",buttonBack:"Back",buttonAdd:"Import File",buttonSettings:"Settings",buttonContents:"Table of Contents",buttonBookmark:"Bookmark",buttonSearch:"Search",buttonJump:"Jump to",buttonSpeech:"Start Text to Speech",buttonSpeechStop:"Stop Text to Speech",buttonContentsRefresh:"Refresh Table of Contents",buttonSearchSubmit:"Search",buttonSearchClear:"Clear Search Result",buttonBookmarkAdd:"Add Bookmark",colorHueRange:"Hue",colorSaturationRange:"Saturation",colorValueRange:"Value",readFontFail:"Cannot open font file. The file format may not be supported by your browser.",listImportFail:"Something wrong when reading text file. Maybe the encoding is not supported.",storageOpenFail:"Cannot access device storage.\ntReader cannot work correctly without storage access.\nThis may due to incognito / private mode of browser or unsupported browser version."},t=[{name:/^en\b/i,lang:"en",locale:e},{name:/^zh\b(?:-(?!.*-Hans)(?:TW|HK|MO)|.*-Hant|$)/i,lang:"zh-TW",locale:{locale:"zh-TW",title:"tReader",titleWithName:"{0} - tReader",listFilterClear:"清除篩選",listSortTitle:"排序",listSortByDateRead:"依最後閱讀時間",listSortByDateAdd:"依加入時間",listSortByTitle:"依標題",listSortCancel:"取消",listImportTip:"正在匯入文字檔……",listNotYetRead:"新",listSearchPlaceholder:"搜尋",listEmptySearchTip:"沒有相符的檔案",listEmptyTip:"按下加號圖示匯入檔案",readContentsTemplate:"目錄範本",readContentsTemplateDescription:"使用星號(*)作為萬用字元",readContentsTemplateHistory:"最近使用過的範本",readContentsTemplateSubmit:"產生目錄",readContentsTemplateClear:"清除",readContentsEmpty:"尚無目錄\n按下重新整理按鈕產生目錄",readBookmarkEmpty:"尚無書籤\n按下新增按鈕新增書籤",readSearchPlaceholder:"搜尋",readSearchInitial:"輸入文字以尋找",readSearchEmpty:"找不到 {0}",readSearchTooMany:"找到 {0} 筆項目，按下以繼續尋找",readPagePrevious:"上一頁",readPageNext:"下一頁",readPageScrollUp:"向上翻",readPageScrollDown:"向下翻",readControlClose:"隱藏按鈕",readAutoScrollStop:"停止捲動",configPageTitle:"設定",configWithDetail:"詳細資料",configModeGroupTitle:"模式",configMode:"閱讀模式",configModeFlip:"翻頁",configModeScroll:"捲動",configThemeGroupTitle:"主題",configTheme:"主題",configThemeAuto:"自動",configThemeLight:"亮色",configThemeDark:"暗色",configDarkThemeGroupTitle:"暗色主題",configDarkThemeColor:"閱讀文字",configDarkThemeBackground:"閱讀背景",configLightThemeGroupTitle:"亮色主題",configLightThemeColor:"閱讀文字",configLightThemeBackground:"閱讀背景",configTextGroupTitle:"閱讀文字",configTextFontFamily:"字型",configTextFontFamilyUpload:"瀏覽字型檔案",configTextFontFamilyDefault:"預設字型",configTextFontFamilyCustom:"自訂字型",configTextFontSize:"大小",configTextFontSizeNum:"{0}",configTextLineHeight:"行高",configTextLineHeightNum:"{0}",configTextParagraphSpacing:"段落間距",configTextParagraphSpacingNum:"{0} 行",configTextLangTag:"語言標記",configTextLangTagTitle:"語言標記",configTextLangTagDescription:"語言標記用於標記文字的語言。語言標記可能影響文字的呈現與断行。",configPreprocessGroupTitle:"前置处理",configPreprocessMultipleNewLine:"合併連續空白行至",configPreprocessMultipleNewLineNum:"{0} 行",configPreprocessMultipleNewLineDisable:"不合併",configPreprocessChineseConvert:"汉字繁简转换",configPreprocessChineseConvertS2T:"簡體轉繁體",configPreprocessChineseConvertT2S:"繁體轉簡體",configPreprocessChineseConvertDisabled:"不使用",configSpeechGroupTitle:"朗讀",configSpeechVoice:"語音",configSpeechVoiceRemote:"(遠端)",configSpeechVoiceEmpty:"未發現可用的語音",configSpeechPitch:"語調",configSpeechPitchNum:e=>0===e?"0 (最低)":2===e?"2 (最高)":1===e?"1 (預設)":String(e),configSpeechRate:"語速",configSpeechRateNum:e=>1===e?"1× (預設)":e+"×",configHelpGroupTitle:"說明",configHelpTopic:"說明",configHelpFilename:"en.html",configHelpCredits:"Open Source Credits",configHelpAbout:"關於",configExpertGroupTitle:"專家",configExpert:"專家設定",configExpertDescription:"若您不清楚如何填寫，請將此處留空。錯誤設定會導致閱讀器無法使用。",buttonRemove:"刪除",buttonBack:"返回",buttonAdd:"新增檔案",buttonSettings:"設定",buttonContents:"目錄",buttonBookmark:"書籤",buttonSearch:"搜尋",buttonJump:"跳到",buttonSpeech:"開始朗讀",buttonSpeechStop:"停止朗讀",buttonContentsRefresh:"重新整理目錄",buttonSearchSubmit:"搜尋",buttonSearchClear:"清除搜尋結果",buttonBookmarkAdd:"新增書籤",colorHueRange:"色調",colorSaturationRange:"飽和",colorValueRange:"亮度",readFontFail:"無法開啟字型檔案\n您的瀏覽器可能不支援該字型檔案格式",listImportFail:"匯入文字檔時發生錯誤\n文字檔可能使用了不受支援的字元編碼",storageOpenFail:"無法存取装置的储存空间\ntReader 需要存取儲存空間以正常運作\n這可能是因為您開啟了瀏覽器的無痕（隱私）瀏覽模式或您的瀏覽器版本不受支援"}},{name:/^zh\b/i,lang:"zh-CN",locale:{locale:"zh-CN",title:"tReader",titleWithName:"{0} - tReader",listFilterClear:"取消过滤",listSortTitle:"排序",listSortByDateRead:"按最后阅读时间",listSortByDateAdd:"按添加时间",listSortByTitle:"按标题",listSortCancel:"取消",listImportTip:"正在读取文本……",listNotYetRead:"新",listSearchPlaceholder:"搜索",listEmptySearchTip:"找不到搜索的文件",listEmptyTip:"点击加号图标导入文件",readContentsTemplate:"目录模板",readContentsTemplateDescription:"使用星号(*)作通配符",readContentsTemplateHistory:"最近设置模板",readContentsTemplateSubmit:"生成目录",readContentsTemplateClear:"清空",readContentsEmpty:"暂无目录\n点击刷新按钮生成目录",readBookmarkEmpty:"暂无书签\n点击添加按钮添加书签",readSearchPlaceholder:"查找",readSearchInitial:"键入文本以查找",readSearchEmpty:"找不到 {0}",readSearchTooMany:"已找到 {0} 个结果，点击以继续查找",readPagePrevious:"上一页",readPageNext:"下一页",readPageScrollUp:"向上翻",readPageScrollDown:"向下翻",readControlClose:"隐藏按钮",readAutoScrollStop:"停止滚动",configPageTitle:"设置",configWithDetail:"详情",configModeGroupTitle:"模式",configMode:"阅读模式",configModeFlip:"翻页",configModeScroll:"滚动",configThemeGroupTitle:"主题",configTheme:"主题",configThemeAuto:"自动",configThemeLight:"浅色",configThemeDark:"深色",configDarkThemeGroupTitle:"深色主题",configDarkThemeColor:"阅读文字",configDarkThemeBackground:"阅读背景",configLightThemeGroupTitle:"浅色主题",configLightThemeColor:"阅读文字",configLightThemeBackground:"阅读背景",configTextGroupTitle:"阅读文字",configTextFontFamily:"字体",configTextFontFamilyUpload:"浏览字体文件",configTextFontFamilyDefault:"默认字体",configTextFontFamilyCustom:"定制字体",configTextFontSize:"字号",configTextFontSizeNum:"{0}",configTextLineHeight:"行高",configTextLineHeightNum:"{0}",configTextParagraphSpacing:"段间距",configTextParagraphSpacingNum:"{0} 行",configTextLangTag:"语言标记",configTextLangTagTitle:"语言标记",configTextLangTagDescription:"语言标记用于标记文本的语言。语言标记可能会影响汉字的渲染和文字的换行。",configPreprocessGroupTitle:"预处理",configPreprocessMultipleNewLine:"压缩连续空行至",configPreprocessMultipleNewLineNum:"{0} 行",configPreprocessMultipleNewLineDisable:"不压缩",configPreprocessChineseConvert:"汉字繁简转换",configPreprocessChineseConvertS2T:"简体转繁体",configPreprocessChineseConvertT2S:"繁体转简体",configPreprocessChineseConvertDisabled:"不使用",configSpeechGroupTitle:"朗读",configSpeechVoice:"语音",configSpeechVoiceRemote:"(远程)",configSpeechVoiceEmpty:"未发现可用的语音",configSpeechPitch:"语调",configSpeechPitchNum:e=>0===e?"0 (最低)":2===e?"2 (最高)":1===e?"1 (默认)":String(e),configSpeechRate:"语速",configSpeechRateNum:e=>1===e?"1× (默认)":e+"×",configHelpGroupTitle:"帮助",configHelpTopic:"帮助",configHelpFilename:"zh_cn.html",configHelpCredits:"Open Source Credits",configHelpAbout:"关于",configExpertGroupTitle:"高级",configExpert:"高级设置",configExpertDescription:"如果您不清楚应当如何填写请将此处留空，错误配置可能导致阅读器无法使用",buttonRemove:"删除",buttonBack:"返回",buttonAdd:"添加文件",buttonSettings:"设置",buttonContents:"目录",buttonBookmark:"书签",buttonSearch:"搜索",buttonJump:"跳转",buttonSpeech:"开始朗读",buttonSpeechStop:"停止朗读",buttonContentsRefresh:"刷新目录",buttonSearchSubmit:"搜索",buttonSearchClear:"清除搜索结果",buttonBookmarkAdd:"添加书签",colorHueRange:"色相",colorSaturationRange:"饱和度",colorValueRange:"明度",readFontFail:"无法打开字体文件\n您的浏览器可能不支持该字体文件类型",listImportFail:"读取文本时发生错误\n文本可能使用了不支持的字符编码",storageOpenFail:"无法访问设备的存储\ntReader 需要访问存储以正常工作\n这可能是因为您启用了浏览器的无痕（隐私）模式或您的浏览器版本不受支持"}}],i=function(){var _navigator$languages$;const i=(_navigator$languages$=navigator.languages.reduce((e,i)=>e!==null&&e!==void 0?e:t.find(e=>e.name.test(i)),null))!==null&&_navigator$languages$!==void 0?_navigator$languages$:t[0];return document.addEventListener("DOMContentLoaded",()=>{document.documentElement.lang=i.lang}),Object.assign({},e,i.locale)}(),s={},n=s;s.getMessage=function(t,...s){const n=Object.prototype.hasOwnProperty.call(i,t)?i[t]:e[t];return"string"==typeof n?n.replace(/\{\d+\}/g,e=>String(s[parseInt(e.slice(1),10)])):"function"==typeof n?String(n(...s)):""};const r={},a=r,o=new Promise(e=>{const t=indexedDB.open("reader");t.addEventListener("success",i=>{e(t.result)}),t.addEventListener("upgradeneeded",e=>{const i=t.result;i.createObjectStore("content"),i.createObjectStore("index",{keyPath:"id"}),i.createObjectStore("config"),i.createObjectStore("list",{keyPath:"id",autoIncrement:!0})}),t.addEventListener("error",t=>{alert(n.getMessage("storageOpenFail")),e(null)})});o.then(e=>{e&&window.addEventListener("beforeunload",()=>{e.close()})});const l={};r.files=l,l.add=function(e,t){return new Promise(async(i,s)=>{const n=await o;n||s();const r=n.transaction(["content","list","index"],"readwrite"),a=r.objectStore("list").add(e);a.addEventListener("success",n=>{const o=e.id=a.result,l=r.objectStore("content").add(t,o);l.addEventListener("success",t=>{const n=r.objectStore("index").add({id:o});n.addEventListener("success",t=>{i(e)}),n.addEventListener("error",e=>{s(n.error)})}),l.addEventListener("error",e=>{s(l.error)})}),a.addEventListener("error",e=>{s(a.error)})})},l.remove=function(e){return new Promise(async(t,i)=>{const s=await o;s||i();const n=s.transaction(["content","list","index"],"readwrite"),r=n.objectStore("list").delete(e);r.addEventListener("success",s=>{const r=n.objectStore("content").delete(e);r.addEventListener("success",s=>{const r=n.objectStore("index").delete(e);r.addEventListener("success",e=>{t()}),r.addEventListener("error",e=>{i()})}),r.addEventListener("error",e=>{i()})}),r.addEventListener("error",e=>{i()})})};const h=function(e,t){var _put$t;const i={get:(e,t)=>e.get(t),put:(e,...t)=>e.put(...t),getAll:e=>e.getAll()}[t],s=(_put$t={put:"readwrite"}[t])!==null&&_put$t!==void 0?_put$t:"readonly";return async function(...t){return new Promise(async(n,r)=>{const a=await o;a||r();const l=a.transaction([e],s).objectStore(e),h=i(l,...t);h.onsuccess=function(e){n(h.result)},h.onerror=function(){r(h.error)}})}};l.list=h("list","getAll"),l.getContent=h("content","get"),l.getMeta=h("list","get"),l.setMeta=h("list","put"),l.getIndex=h("index","get"),l.setIndex=h("index","put");const c={};r.config=c,c.getItem=h("config","get"),c.setItem=h("config","put");const d={},u=d;d.EXPERT_CONFIG_NAME="expert";const g=[];d.get=async e=>await a.config.getItem(e),d.set=async(e,t)=>(await a.config.setItem(t,e),Promise.resolve().then(()=>{g.forEach(i=>{i.name===e&&i.listener(t)})}),t),d.expert=async(e,t,i,{normalize:s,validator:n}={})=>{const r=await d.get(d.EXPERT_CONFIG_NAME)||"";let a="";const o=r.split("\n").filter(t=>{if(/^\s*\[.*\]\s*$/.test(t))a=t.trim().slice(1,-1);else if(!/^\s*[;#]/.test(t)&&t.includes("=")){const i=t.split("=",1)[0].trim();return(a?a+"."+i:i)===e}return!1}).pop();let l=null==o?i:o.slice(o.indexOf("=")+1).trim();try{l=JSON.parse(l)}catch(e){}let h=i;try{let e=!0;if(e="number"===t?"number"==typeof l&&(n?n(l):!Number.isNaN(l)):"string"===t?"string"==typeof l&&(!n||n(l)):"boolean"===t?"boolean"==typeof l&&(!n||n(l)):!n||n(l),!e)return i;h=s?s(l,i):l}catch(e){}return h};const p=(e,t)=>g.findIndex(i=>i.name===e&&i.listener===t);d.addListener=(e,t)=>{-1===p(e,t)&&g.push({name:e,listener:t})},d.removeListener=(e,t)=>{const i=p(e,t);-1!==i&&g.splice(i,1)};class m{constructor(e){this.element=e,this.initialized=!1,this.active=!1,this.router=null,this.hide()}setRouter(e){this.router=e}show(){this.element.classList.add("active-page"),this.element.removeAttribute("aria-hidden")}hide(){this.element.classList.remove("active-page"),this.element.setAttribute("aria-hidden","true")}async onFirstActivate(){}async onActivate(){}async onUpdate(){}async onInactivate(){}async activate(e){this.initialized||(this.initialized=!0,await this.onFirstActivate()),this.active?await this.onUpdate(e):(await this.onActivate(e),this.active=!0,this.show())}async inactivate(){this.hide(),await this.onInactivate(),this.active=!1}isActive(){return this.active}matchUrl(e){return!1}getUrl(e){return"/"}isPreserve(){return!0}}const f={},v=f;f.add=async function({title:e,content:t}){const i=new Date,s={title:e,createTime:i,lastAccessTime:i,length:t.length};return await a.files.add(s,t),s},f.list=async function(){return a.files.list()},f.getMeta=async function(e){return a.files.getMeta(e)},f.setMeta=async function(e){return e.lastAccessTime=new Date,a.files.setMeta(e)},f.getIndex=async function(e){return a.files.getIndex(e)},f.setIndex=async function(e){return a.files.setIndex(e)},f.content=async function(e){return a.files.getContent(e)},f.remove=async function(e){return a.files.remove(e)};const C={},S=C,x=["utf-8","gbk","big5","utf-16le","utf-16be","utf-8"];C.readFile=async function(e){return new Promise((t,i)=>{const s=new FileReader;s.addEventListener("load",async e=>{const n=s.result,r=(await u.expert("text.encoding","string","")).split(",").map(e=>e.trim()).filter(e=>e),a=[...r,...x].reduce((e,t,i,s)=>{if(null!=e)return e;const a=![r.length-1,s.length-1].includes(i),o=new TextDecoder(t,{fatal:a});try{return o.decode(n)}catch(e){return null}},null);a&&t(a),i(null)}),s.addEventListener("error",e=>{i(s.error)}),s.readAsArrayBuffer(e)})},C.parseFilename=function(e){return e.replace(/\.[^.]+$/,"")},C.useRegExpForContent=function(e){if(/\/.*\/[a-zA-Z]*/.test(e)){const[t,i,s]=e.match(/\/(.*)\/(.*)/);try{return new RegExp(i,s)}catch(e){return null}}return null},C.generateContent=function(e,t,{maxLength:i,limit:s}){let n=C.useRegExpForContent(t);if(!n){const e=t.replace(/./g,e=>" "===e?"\\s+":"*"===e?".*":"?"===e?".":e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,e=>`\\u${e.charCodeAt().toString(16).padStart(4,0)}`));n=new RegExp(`^\\s*(?:${e})`,"u")}const r=[];let a=0;return e.split("\n").some(e=>{if(e.length<=i&&n.test(e)){if(r.length>s)return!0;r.push({title:e.trim(),cursor:a})}return a+=e.length+1,!1})?null:r};const b=function(e){return e.replace(/\r\n|\r/g,"\n")},y=async function(e){const t=await u.get("max_empty_lines");if("disable"===t)return e;const i=Number(t);return e.replace(new RegExp(`(?:\\n\\s*){${i},}\\n`,"g"),"\n".repeat(i+1))},P=async function(e){const t=await u.get("chinese_convert");if("disable"===t)return e;const i="s2t"===t?"./data/han/s2t.json":"./data/han/t2s.json",s=await fetch(i).then(e=>e.json());let n="",r=0;const a=Object.prototype.hasOwnProperty;for(let t of e)for(;;){const e=s[r],i=a.call(e,t);if(!i&&0===r){n+=t;break}if(i){const[i,s]=e[t];i&&(n+=i),r=s;break}const[o,l]=e[""];o&&(n+=o),r=l}for(;0!==r;){const e=s[r],[t,i]=e[""];t&&(n+=t),r=i}return n};C.preprocess=async function(e){return[b,y,P].reduce(async(e,t)=>t(await e),e)};const E={},L=new Map;Array.from(document.querySelectorAll("template[id]")).forEach(e=>{L.set(e.id,e),e.remove()});const w=E;E.create=function(e){const t=e.replace(/[A-Z]/g,e=>"_"+e.toLowerCase()),i=L.get(t).content.cloneNode(!0).firstElementChild,s=new Map;return Array.from(i.querySelectorAll("[data-ref]")).forEach(e=>{s.set(e.dataset.ref,e),e.removeAttribute("data-ref")}),s.set("root",i),s},E.icon=function(e,t=null){const i=E.create("icon").get("root");return i.classList.add("icon-"+e),t?(i.setAttribute("title",t),i.setAttribute("aria-label",t)):i.setAttribute("aria-hidden","true"),i},E.iconButton=function(e,t=null){const i=E.create("iconButton"),s=E.icon(e,t);return i.get("icon").appendChild(s),i.get("root")};const k={},A=k,T=new WeakMap;k.disableKeyboardFocus=function(e){T.has(e)||T.set(e,new WeakMap);const t=T.get(e);Array.from(e.querySelectorAll("input, select, textarea, button, object, a[href], [tabindex]")).forEach(e=>{const i=e.getAttribute("tabindex");"-1"!==i&&(t.set(e,i),e.setAttribute("tabindex","-1"))})},k.enableKeyboardFocus=function(e){if(!T.has(e))return;const t=T.get(e);T.delete(e),Array.from(e.querySelectorAll("input, select, textarea, button, object, a[href], [tabindex]")).forEach(e=>{if("-1"!==e.getAttribute("tabindex"))return;if(!t.has(e))return;const i=t.get(e);null==i?e.removeAttribute("tabindex"):e.setAttribute("tabindex",i),t.delete(e)})};class M{constructor(e,{minDistanceX:t=20,minDistanceY:i=20,clickGridX:s=1,clickGridY:n=1,yRadian:r=Math.PI/2}={}){this.listeners=new Map,this.minDistanceX=t,this.minDistanceY=i,this.minDistance=Math.min(t,i),this.clickGridX=s,this.clickGridY=n;let a=null,o=null,l=null;const h=([e,t])=>{if(Math.hypot(e,t)>this.minDistance){const i=Math.atan2(t,e);return Math.abs(i-(i>0?1:-1)*Math.PI/2)<r/2?"y":"x"}return null},c=({touch:e})=>{if(this.trigger("end",{touch:e}),l){const t="x"===l?"cancelx":"cancely";this.trigger(t,{touch:e})}a=null,o=null,l=null},d=new R(e);d.onTouchStart(({position:[e,t],touch:i})=>{a=[e,t],o=[e,t],l=null,this.trigger("start",[e,t],{touch:i})}),d.onTouchMove(({position:[e,t],touch:i})=>{if(!a)return;const[s,n]=[e-a[0],t-a[1]];if(o=[e,t],null===l&&(l=h([s,n])),l){const e="x"===l?s:n,t="x"===l?"movex":"movey";this.trigger(t,e,{touch:i})}}),d.onTouchEnd(({touch:t})=>{if(!o||!a)return void c();this.trigger("end",{touch:t});const[i,s]=[o[0]-a[0],o[1]-a[1]],n="x"===l?i:"y"===l?s:0;if(l){const e="x"===l?this.minDistanceX:this.minDistanceY;if(Math.abs(n)<e){const e="x"===l?"cancelx":"cancely";this.trigger(e,{touch:t})}else{const e="x"===l?i>0?"slideright":"slideleft":s>0?"slidedown":"slideup";this.trigger(e,{touch:t})}}else{const i=e.getBoundingClientRect(),s=a[0]-i.x,n=i.width,r=a[1]-i.y,o=i.height,l=Math.max(Math.min(Math.floor(s*this.clickGridX/n),this.clickGridX-1),0),h=Math.max(Math.min(Math.floor(r*this.clickGridY/o),this.clickGridY-1),0);this.trigger("touch",{touch:t,grid:{x:l,y:h}})}a=null,o=null,l=null}),d.onTouchCancel(c),this.dispatch=()=>{d.dispatch()}}trigger(e,...t){this.listeners.has(e)&&this.listeners.get(e).forEach(e=>{e(...t)})}addListener(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}onStart(e){return this.addListener("start",e)}onEnd(e){return this.addListener("end",e)}onTouch(e){return this.addListener("touch",e)}onMoveX(e){return this.addListener("movex",e)}onMoveY(e){return this.addListener("movey",e)}onCancelX(e){return this.addListener("cancelx",e)}onCancelY(e){return this.addListener("cancely",e)}onSlideUp(e){return this.addListener("slideup",e)}onSlideDown(e){return this.addListener("slidedown",e)}onSlideLeft(e){return this.addListener("slideleft",e)}onSlideRight(e){return this.addListener("slideright",e)}}class R{constructor(e){this.element=e,this.touchMoveCallbackList=[],this.touchStartCallbackList=[],this.touchEndCallbackList=[],this.touchCancelCallbackList=[];let t=!1,i=!1;const s=()=>{document.removeEventListener("mouseup",r),document.removeEventListener("mouseleave",a),document.removeEventListener("mousemove",o)},n=e=>{i?i=!1:0===e.button&&(t=!0,this.triggerCallback("start",{position:[e.pageX,e.pageY],touch:!1}),document.addEventListener("mouseup",r),document.addEventListener("mouseleave",a),document.addEventListener("mousemove",o))},r=e=>{t&&this.triggerCallback("end",{touch:!1}),t=!1,s()},a=e=>{t&&this.triggerCallback("cancel",{touch:!1}),t=!1,s()},o=e=>{t&&(0!==e.button?a():this.triggerCallback("move",{position:[e.pageX,e.pageY],touch:!1}))},l=()=>{document.removeEventListener("touchend",c),document.removeEventListener("touchcancel",d),document.removeEventListener("touchmove",u)},h=e=>{if(e.touches.length>1)return;i=!0;const t=e.touches.item(0);this.triggerCallback("start",{position:[t.pageX,t.pageY],touch:!0}),document.addEventListener("touchend",c),document.addEventListener("touchcancel",d),document.addEventListener("touchmove",u)},c=e=>{i&&this.triggerCallback("end",{touch:!0}),l()},d=e=>{i&&this.triggerCallback("cancel",{touch:!0}),l()},u=e=>{const t=e.touches.item(0);i&&this.triggerCallback("move",{position:[t.pageX,t.pageY],touch:!0})};this.element.addEventListener("mousedown",n),this.element.addEventListener("touchstart",h,{passive:!0}),this.dispatch=()=>{this.element.removeEventListener("mousedown",n),s(),this.element.removeEventListener("touchstart",h,{passive:!0}),l()}}triggerCallback(e,t){({move:this.touchMoveCallbackList,start:this.touchStartCallbackList,end:this.touchEndCallbackList,cancel:this.touchCancelCallbackList})[e].forEach(e=>{e(t)})}onTouchMove(e){this.touchMoveCallbackList.push(e)}onTouchStart(e){this.touchStartCallbackList.push(e)}onTouchEnd(e){this.touchEndCallbackList.push(e)}onTouchCancel(e){this.touchCancelCallbackList.push(e)}}class B{constructor(e,t){var _t$mayRemove;this.container=e,this.render=t.render,this.list=t.list,this.elements=new Map,this.hasClick="function"==typeof t.onItemClick||this.selectable,this.hasRemove="function"==typeof t.onRemove,this.onItemClick=t.onItemClick,this.onRemove=t.onRemove,this.mayRemove=(_t$mayRemove=t.mayRemove)!==null&&_t$mayRemove!==void 0?_t$mayRemove:()=>!0,this.selectable=t.selectable,this.selected=new Set,this.emptyListRender=t.emptyListRender,this.listElement=this.container.appendChild(document.createElement("ul")),this.listElement.classList.add("item-list"),this.selectable&&(this.listElement.classList.add("item-list-selectable"),this.listElement.setAttribute("role","listbox")),this.emptyListRender&&(this.emptyItem=document.createElement("li"),this.emptyItem.classList.add("list-item","list-item-empty"),this.emptyListRender(this.emptyItem)),this.renderList();const i=e=>{const t=e.target;if(!(e.target instanceof HTMLElement))return null;const i=t.closest(".list-item-container");if(!i)return null;const s=i.querySelector(".list-item-content-wrap"),n=this.list.findIndex((e,t)=>this.elements.get(t)===s);return-1===n?null:n};"function"==typeof this.onItemClick&&this.listElement.addEventListener("click",e=>{this.hasRemove&&this.listElement.dispatchEvent(new Event("__hide_remove"));const t=i(e);if(null===t)return;const s=this.list[t];this.onItemClick(s,t)}),this.hasRemove&&this.listElement.addEventListener("contextmenu",e=>{const t=i(e);if(null===t)return;const s=this.elements.get(t).closest(".list-item");if(s.classList.contains("list-item-show-remove")){const e=new KeyboardEvent("keydown",{code:"Escape"});s.dispatchEvent(e)}else{const e=new KeyboardEvent("keydown",{code:"Delete"});s.dispatchEvent(e)}e.preventDefault()}),this.listElement.addEventListener("scroll",e=>{0!==this.listElement.scrollLeft&&(this.listElement.scrollLeft=0)})}renderItem(e,t){const i=document.createElement("li");i.classList.add("list-item");const s=this.hasClick?"button":"div",r=i.appendChild(document.createElement(s));this.hasClick&&(r.type="button"),r.classList.add("list-item-container"),r.dataset.listIndex=t,this.selectable&&(r.appendChild(w.icon("checkmark")).classList.add("list-item-selected-icon"),r.setAttribute("role","option"),r.setAttribute("aria-selected","false"));const a=r.appendChild(document.createElement("div"));if(a.classList.add("list-item-content-wrap"),a.setAttribute("tabindex","-1"),this.render(a,e,t),this.elements.set(t,a),this.hasRemove&&this.mayRemove(e,t)){i.classList.add("list-item-has-remove");const t=w.create("listRemoveAction"),s=t.get("button");s.addEventListener("click",()=>{const t=this.list.indexOf(e);-1!==t&&this.onRemove(e,t)}),s.setAttribute("aria-label",n.getMessage("buttonRemove")),i.appendChild(t.get("root"));const r=120,a=20;let o=!1,l=!1;const h=(e,t)=>{if("move"===e){i.classList.add("list-item-slide-remove"),document.body.classList.add("noscroll");const e=o?t-r:t,s=Math.min(0,Math.max(-r-a,e));i.style.left=s+"px",l=!0,this.listElement.dispatchEvent(new Event("__hide_remove"))}else i.classList.remove("list-item-slide-remove"),document.body.classList.remove("noscroll"),window.requestAnimationFrame(()=>{"show"===e?(o=!0,i.style.left=-r+"px",i.classList.add("list-item-show-remove")):"hide"===e&&(o=!1,i.style.left="0px",i.classList.remove("list-item-show-remove")),i.scrollLeft=0}),l=!1},c=new M(i);c.onMoveX(e=>{h("move",e)}),c.onSlideLeft(()=>{h("show")}),c.onSlideRight(()=>{h("hide")}),c.onCancelX(()=>{h("cancel")}),this.listElement.addEventListener("__hide_remove",()=>{o&&!l&&h("hide")}),i.addEventListener("keydown",t=>{if(["Delete","ArrowLeft"].includes(t.code)){if(this.listElement.dispatchEvent(new Event("__hide_remove")),o){const t=this.list.indexOf(e);this.onRemove(e,t)}else h("show")}else["Enter","Space","Escape","ArrowRight"].includes(t.code)&&o&&h("hide")}),s.addEventListener("focus",e=>{h("show")}),s.addEventListener("blur",e=>{h("hide")})}return i}renderList(){this.listElement.innerHTML="",this.emptyItem&&this.listElement.appendChild(this.emptyItem),this.elements.clear(),this.selected.clear(),this.list.forEach((e,t)=>{const i=this.renderItem(e,t);this.listElement.appendChild(i)})}dispatch(){this.clearList(),this.listElement.remove()}isListEmpty(){return 0===this.list.length}clearList(){this.list.splice(0),this.renderList()}setList(e){this.list.splice(0,this.list.length,...e),this.renderList()}appendList(e){const t=this.list.length;this.list.push(...e),e.forEach((e,i)=>{const s=this.renderItem(e,t+i);this.listElement.appendChild(s)})}setItem(e,t){if(t<this.list.length)this.list.splice(t,1,e),this.render(this.elements.get(t),e,t);else if(t===this.list.length){this.list.push(e);const i=this.renderItem(e,t);this.listElement.appendChild(i)}}getItem(e){return this.list[e]}getItemElement(e){return this.elements.get(e)}setSelectItem(e,t){if(!this.selectable)return;const i=this.elements.get(e).closest(".list-item"),s=i.querySelector(".list-item-container");t?(i.classList.add("list-item-selected"),s.setAttribute("aria-selected","true"),this.selected.add(e)):(i.classList.remove("list-item-selected"),s.setAttribute("aria-selected","false"),this.selected.delete(e))}scrollIntoView(e,t){this.elements.get(e).scrollIntoView(t!==null&&t!==void 0?t:{block:"nearest"})}clearSelectItem(){this.selectable&&Array.from(this.selected).forEach(e=>this.setSelectItem(e,!1))}getSelectItems(){return this.selectable?Array.from(this.selected).map(e=>this.list[e]):null}renderRemoveItem(e){e.setAttribute("aria-hidden","true"),e.classList.add("list-item-remove-ani"),e.style.height=e.clientHeight+"px",window.requestAnimationFrame(()=>{e.style.height="0",setTimeout(()=>{e.remove()},200)})}indexMapping(e){const t=new Map;this.elements.forEach((i,s)=>{const n=e(s);null!=n&&t.set(n,i)}),this.elements=t;const i=new Set;this.selected.forEach(t=>{const s=e(t);null!=s&&i.add(s)}),this.selected=i}removeItem(e){this.list.splice(e,1);const t=this.elements.get(e).closest(".list-item");this.renderRemoveItem(t),this.indexMapping(t=>t===e?null:t-(t>e)),this.focusItemContent(e)}insertItem(e,t){if(t<0||t>this.list.length)return;this.list.splice(t,0,e);const i=this.elements.get(t).closest(".list-item");this.indexMapping(e=>e+(e>=t));const s=this.renderItem(e,t);i.parentNode.insertBefore(s,i)}focusItemContent(e){this.list.length&&this.elements.get(Math.min(e,this.list.length-1)).focus()}}class I{constructor(e,t){this.container=e,this.readPage=t,this.isCurrent=!1,this.hide()}show(){this.isCurrent=!0,this.container.classList.add("read-sub-page-current"),this.container.removeAttribute("aria-hidden"),A.enableKeyboardFocus(this.container),A.disableKeyboardFocus(this.readPage.controlPage.container)}hide(){this.isCurrent=!1,this.container.classList.remove("read-sub-page-current"),this.container.setAttribute("aria-hidden","true"),A.disableKeyboardFocus(this.container),A.enableKeyboardFocus(this.readPage.controlPage.container)}currentActive(){return this.isCurrent}onFirstActivate(){}onActivate(){this.hide()}onInactivate(){}cursorChange(e,t){}}class F extends I{constructor(e,t,i,s,n){super(e,n),this.isCurrent=!1,this.isShow=!1,this.tabItem=t,this.pageIndex=i,this.indexPage=s,this.tabGroup=this.tabItem.closest(".tab-group"),this.pageButtonAction=this.pageButtonAction.bind(this)}updateListRender(){this.itemList&&(this.isCurrent&&this.isShow?(this.updateCurrentHighlight(),A.enableKeyboardFocus(this.container)):A.disableKeyboardFocus(this.container))}setCurrent(){this.isCurrent=!0,this.container.removeAttribute("aria-hidden"),this.updateListRender()}unsetCurrent(){this.isCurrent=!1,this.container.setAttribute("aria-hidden","true"),this.updateListRender()}show(){this.isShow=!0,this.updateListRender()}hide(){this.isShow=!1,this.updateListRender()}createPageButton(){}onFirstActivate(){super.onFirstActivate();const e=w.create("header");this.headerElement=this.container.insertBefore(e.get("root"),this.container.firstChild);const t=w.iconButton("back",n.getMessage("buttonBack"));this.backButton=e.get("left").appendChild(t),this.pageButton=this.createPageButton(),e.get("right").appendChild(this.pageButton),this.tabItem.addEventListener("click",e=>{this.indexPage.setCurrentSubPage(this)}),this.backButton.addEventListener("click",e=>{this.indexPage.hide()}),this.container.addEventListener("keydown",e=>{e.stopPropagation()}),this.listElement=this.container.querySelector(".index-list")}onActivate(){var _this$onRemoveItem;const e=this.getListItems(),t=this.onItemClick.bind(this),i=this.listItemRender.bind(this),s=this.emptyListRender.bind(this),n=(_this$onRemoveItem=this.onRemoveItem)===null||_this$onRemoveItem===void 0?void 0:_this$onRemoveItem.bind(this);this.itemList=new B(this.listElement,{list:e.slice(0),onItemClick:t,render:i,selectable:!0,emptyListRender:s,onRemove:n}),this.currentContentsIndex=null,this.pageButton.addEventListener("click",this.pageButtonAction)}onInactivate(){this.itemList.dispatch(),this.itemList=null}enablePageButton(){this.pageButton.disabled=!1}disablePageButton(){this.pageButton.disabled=!0}getCurrentHighlightIndex(){return null}updateCurrentHighlight(){const e=this.getCurrentHighlightIndex(),t=-1===e?null:e;this.currentContentsIndex!==t&&(this.itemList.clearSelectItem(),null!=t&&(this.itemList.setSelectItem(t,!0),this.itemList.scrollIntoView(t)),this.currentContentsIndex=t)}getListItems(){return[]}cursorChange(e,t){this.itemList&&this.updateCurrentHighlight()}emptyListRender(){}listItemRender(){}onItemClick(e){this.readPage.setCursor(e.cursor,{resetSpeech:!0,resetRender:!1}),this.readPage.useSideIndex||this.indexPage.hide()}pageButtonAction(){}setList(e){this.itemList.setList(e),this.currentContentsIndex=null,this.updateCurrentHighlight()}updateList(){this.setList([...this.getListItems()])}}class _{constructor(e){this.name=e.name,this.title=e.title,this.default=null,this.initialized=!1,this.rendered=!1,this.normalizeConfig(),_.globalIndex||(_.globalIndex=0),this.index=_.globalIndex++}get type(){throw Error("Unimplementated")}setConfig(e){return u.set(this.name,e)}getConfig(e){return u.get(this.name,e)}render(e){const t=e.appendChild(document.createElement("div"));t.classList.add("config-item");const i=t.appendChild(document.createElement("div"));i.classList.add("config-item-title"),i.textContent=this.title,this.container=t,this.titleElement=i,this.rendered=!0,this.titleElement.id="config_item_"+this.index}renderValue(e){}isValidValue(e){return!0}async normalizeConfig(){let e=null;try{e=await u.get(this.name)}catch(e){}await this.isValidValue(e)||(await u.set(this.name,this.default),this.rendered&&this.renderValue(this.default))}async setup(e){this.initialized||(this.initialized=!0,this.render(e),await this.normalizeConfig(),await u.get(this.name).then(e=>{this.renderValue(e),u.addListener(this.name,e=>{this.renderValue(e)})}))}detailIcon(){const e=w.icon("detail");return e.classList.add("config-item-detail"),e.setAttribute("aria-label",n.getMessage("configWithDetail")),e}}class H extends _{constructor(e){super(e),this.select=e.select,this.default=e.default}get type(){return"select"}isValidValue(e){return null!=this.select.find(t=>t.value===e)}render(e){super.render(e);const t=e.firstChild;this.resultElement=t.appendChild(document.createElement("span")),this.resultElement.classList.add("config-item-value"),t.appendChild(this.detailIcon()),this.resultElement.id="config_item_value_"+this.index,this.resultElement.setAttribute("aria-labelby",this.titleElement.id),this.titleElement.setAttribute("aria-labelby",this.resultElement.id)}renderValue(e){this.resultElement.textContent=this.select.find(t=>t.value===e).text}}class V extends _{constructor(e){super(e),this.default=e.default}get type(){return"color"}isValidValue(e){return/^#[a-f0-9]{6}$/i.test(e)}render(e){super.render(e);const t=e.firstChild;this.resultElement=t.appendChild(document.createElement("span")),this.resultElement.classList.add("config-item-value","config-item-color-value"),t.appendChild(this.detailIcon()),this.resultElement.id="config_item_value_"+this.index,this.resultElement.setAttribute("aria-labelby",this.titleElement.id),this.titleElement.setAttribute("aria-labelby",this.resultElement.id)}renderValue(e){this.resultElement.style.backgroundColor=e,this.resultElement.setAttribute("aria-label",e)}}class D extends _{setConfig(e){}getConfig(e){}renderValue(e){}isValidValue(e){return!0}async normalizeConfig(){}async setup(e){this.initialized||(this.initialized=!0,this.render(e))}}class O extends D{constructor(e){super(e),this.url=e.url}get type(){return"webpage"}}const N=[{title:n.getMessage("configModeGroupTitle"),items:[new H({name:"view_mode",title:n.getMessage("configMode"),select:[{value:"flip",text:n.getMessage("configModeFlip")},{value:"scroll",text:n.getMessage("configModeScroll")}],default:"flip"})]},{title:n.getMessage("configThemeGroupTitle"),items:[new H({name:"theme",title:n.getMessage("configTheme"),select:[{value:"auto",text:n.getMessage("configThemeAuto")},{value:"light",text:n.getMessage("configThemeLight")},{value:"dark",text:n.getMessage("configThemeDark")}],default:"auto"})]},{title:n.getMessage("configDarkThemeGroupTitle"),items:[new V({name:"dark_text",title:n.getMessage("configDarkThemeColor"),default:"#ffffff"}),new V({name:"dark_background",title:n.getMessage("configDarkThemeBackground"),default:"#000000"})]},{title:n.getMessage("configLightThemeGroupTitle"),items:[new V({name:"light_text",title:n.getMessage("configLightThemeColor"),default:"#000000"}),new V({name:"light_background",title:n.getMessage("configLightThemeBackground"),default:"#ffffff"})]},{title:n.getMessage("configTextGroupTitle"),items:[new class extends _{constructor(e){super(e),this.default=e.default}get type(){return"font"}async isValidValue(e){if(0===e)return!0;const t=await u.get("font_list");return!!Array.isArray(t)&&t.find(t=>t.id===e)}render(e){super.render(e);const t=e.firstChild;this.resultElement=t.appendChild(document.createElement("span")),this.resultElement.classList.add("config-item-value"),t.appendChild(this.detailIcon()),this.resultElement.id="config_item_value_"+this.index,this.resultElement.setAttribute("aria-labelby",this.titleElement.id),this.titleElement.setAttribute("aria-labelby",this.resultElement.id)}renderValue(e){const t=e?"configTextFontFamilyCustom":"configTextFontFamilyDefault",i=n.getMessage(t);this.resultElement.textContent=i}}({name:"font_family",title:n.getMessage("configTextFontFamily"),default:null}),new H({name:"font_size",title:n.getMessage("configTextFontSize"),select:[10,11,12,14,16,18,20,22,24,26,28,30,32,36,40,48,56,64].map(e=>({value:String(e),text:n.getMessage("configTextFontSizeNum",e)})),default:"18"}),new H({name:"line_height",title:n.getMessage("configTextLineHeight"),select:[1,1.1,1.2,1.3,1.4,1.5,1.6,1.8,2].map(e=>({value:String(e),text:n.getMessage("configTextLineHeightNum",e)})),default:"1.5"}),new H({name:"paragraph_spacing",title:n.getMessage("configTextParagraphSpacing"),select:[0,.2,.5,.8,1,1.2,1.5,2].map(e=>({value:String(e),text:n.getMessage("configTextParagraphSpacingNum",e)})),default:"0.5"}),new class extends _{constructor(e){super(e),this.default=e.default,this.label=e.label,this.description=e.description}get type(){return"text"}isValidValue(e){return"string"==typeof e}render(e){super.render(e);const t=e.firstChild;this.resultElement=t.appendChild(document.createElement("span")),this.resultElement.classList.add("config-item-value"),t.appendChild(this.detailIcon()),this.resultElement.id="config_item_value_"+this.index,this.resultElement.setAttribute("aria-labelby",this.titleElement.id),this.titleElement.setAttribute("aria-labelby",this.resultElement.id)}renderValue(e){this.resultElement.textContent=e}}({name:"cjk_lang_tag",title:n.getMessage("configTextLangTag"),label:n.getMessage("configTextLangTagTitle"),default:navigator.language||"und",description:n.getMessage("configTextLangTagDescription")})]},{title:n.getMessage("configPreprocessGroupTitle"),items:[new H({name:"max_empty_lines",title:n.getMessage("configPreprocessMultipleNewLine"),select:[{value:"disable",text:n.getMessage("configPreprocessMultipleNewLineDisable")},...[0,1,2,3,4].map(e=>({value:String(e),text:n.getMessage("configPreprocessMultipleNewLineNum",e)}))],default:"disable"}),new H({name:"chinese_convert",title:n.getMessage("configPreprocessChineseConvert"),select:[{value:"disable",text:n.getMessage("configPreprocessChineseConvertDisabled")},{value:"s2t",text:n.getMessage("configPreprocessChineseConvertS2T")},{value:"t2s",text:n.getMessage("configPreprocessChineseConvertT2S")}],default:"disable"})]},{title:n.getMessage("configSpeechGroupTitle"),items:[new class extends _{constructor(e){super(e),this.default=e.default}get type(){return"voice"}render(e){super.render(e),e.firstChild.appendChild(this.detailIcon())}}({name:"speech_voice",title:n.getMessage("configSpeechVoice"),default:null}),new H({name:"speech_pitch",title:n.getMessage("configSpeechPitch"),select:[...Array(21)].map((e,t)=>t/10).map(e=>({value:String(e),text:n.getMessage("configSpeechPitchNum",e)})),default:"1"}),new H({name:"speech_rate",title:n.getMessage("configSpeechRate"),select:[...Array(101)].map((e,t)=>t/10).slice(1).map(e=>({value:String(e),text:n.getMessage("configSpeechRateNum",e)})),default:"1"})]},{title:n.getMessage("configHelpGroupTitle"),items:[new O({title:n.getMessage("configHelpTopic"),url:`./help/${n.getMessage("configHelpFilename")}`}),new O({title:n.getMessage("configHelpCredits"),url:"./help/credits.html"}),new O({title:n.getMessage("configHelpAbout"),url:"./help/about.html"})]},{title:n.getMessage("configExpertGroupTitle"),items:[new class extends _{constructor(e){super(e),this.default=e.default,this.label=e.label,this.description=e.description}get type(){return"expert"}isValidValue(e){return"string"==typeof e}render(e){super.render(e),e.firstChild.appendChild(this.detailIcon())}renderValue(e){}}({name:u.EXPERT_CONFIG_NAME,default:"",title:n.getMessage("configExpert"),description:n.getMessage("configExpertDescription")})]},{list:!1,items:[new class extends _{constructor(e){var _e$validator,_e$normalize;super(e),this.isValidValue=(_e$validator=e.validator)!==null&&_e$validator!==void 0?_e$validator:()=>!0,this.normalizeConfig=(_e$normalize=e.normalize)!==null&&_e$normalize!==void 0?_e$normalize:e=>e}get type(){return"value"}async setConfig(e){const t=this.normalizeConfig(this.isValidValue(e)?e:null);await u.set(this.name,t)}async getConfig(e){const t=await u.get(this.name,e);return this.normalizeConfig(t)}}({name:"contents_history",default:[],description:n.getMessage("readContentsTemplateDescription"),validator:e=>Array.isArray(e)&&e.every(e=>"string"==typeof e),normalize:e=>Array.isArray(e)?e.filter((t,i)=>"string"==typeof t&&t&&e.indexOf(t)===i).slice(0,10):[]})]}],z=N.filter(e=>!1!==e.list),q=(new Set(N.flatMap(e=>e.items)),new Map(N.flatMap(e=>e.items.map(e=>[e.name,e]))));class U{constructor(){this.keyboardEvents=this.keyboardEvents.bind(this)}onFirstActivate(e,t){this.contentsPage=e,this.container=t.querySelector("#read_index_contents_config"),this.historyOption=q.get("contents_history"),this.showTemplatePage=!0;const i=w.create("header");this.container.insertBefore(i.get("root"),this.container.firstChild);const s=w.iconButton("back",n.getMessage("buttonBack"));this.backButton=i.get("left").appendChild(s),this.backButton.addEventListener("click",e=>{this.hide()}),this.templateForm=this.container.querySelector("form"),this.templateInput=this.container.querySelector("input"),this.templateListElement=this.container.querySelector(".contents-history-list"),this.templateTitle=this.container.querySelector(".contents-history-title"),this.templateButton=w.iconButton("go",n.getMessage("readContentsTemplateSubmit")),this.templateForm.appendChild(this.templateButton),this.templateButton.classList.add("submit-button"),this.templateButton.type="submit",this.templateClear=w.iconButton("remove",n.getMessage("readContentsTemplateClear")),this.templateTitle.appendChild(this.templateClear),this.templateClear.classList.add("contents-history-clear"),this.templateClear.addEventListener("click",e=>{this.historyOption.setConfig([]),this.renderTemplateHistoryList(null)}),this.templateForm.addEventListener("submit",e=>{e.preventDefault();const t=this.templateInput.value;t&&this.addHistory(t),this.contentsPage.refreshContents(t),this.hide()}),this.hide()}renderTemplateHistoryList(e){if(!e||!e.length)return this.templateTitle.hidden=!0,void(this.templateList&&(this.templateList.dispatch(),this.templateList=null));const t=e.slice(0);this.templateTitle.hidden=!1,this.templateList&&this.templateList.dispatch(),this.templateList=new B(this.templateListElement,{list:t,onItemClick:e=>{this.addHistory(e),this.contentsPage.refreshContents(e),this.hide()},onRemove:async(e,i)=>{this.templateList.removeItem(i),await this.historyOption.setConfig(t)},render:(e,t)=>{if(e.firstChild)return;const i=e.appendChild(document.createElement("div"));i.classList.add("contents-history-item"),i.textContent=t,i.lang=this.contentsPage.readPage.langTag,S.useRegExpForContent(t)&&i.classList.add("contents-history-item-regex")}})}show(){if(!this.container)return;this.showTemplatePage=!0,this.contentsPage.headerElement.hidden=!0,this.contentsPage.listElement.hidden=!0,this.contentsPage.indexPage.tabGroup.hidden=!0,this.container.hidden=!1,this.renderTemplateHistoryList(null),this.historyOption.getConfig().then(e=>{this.showTemplatePage&&this.renderTemplateHistoryList(e)});const e=this.contentsPage.readPage.index.content;this.templateInput.value=e?e.template:"",this.templateInput.lang=this.contentsPage.readPage.langTag,this.container.addEventListener("keydown",this.keyboardEvents)}hide(){this.showTemplatePage&&(this.showTemplatePage=!1,this.templateList&&(this.templateList.dispatch(),this.templateList=null),this.container&&(this.contentsPage.headerElement.hidden=!1,this.contentsPage.listElement.hidden=!1,this.contentsPage.indexPage.tabGroup&&(this.contentsPage.indexPage.tabGroup.hidden=!1),this.container.hidden=!0),this.container.contains(document.activeElement)&&document.activeElement.blur(),this.container.removeEventListener("keydown",this.keyboardEvents))}async addHistory(e){const t=(await this.historyOption.getConfig()).filter(t=>t!==e);t.unshift(e),t.splice(20),await this.historyOption.setConfig(t)}keyboardEvents(e){"Escape"!==e.code||e.target.closest("input")||(this.hide(),e.stopPropagation())}}class G extends F{constructor(e,t,i,s,n){super(e,t,i,s,n),this.templatePage=new U}onFirstActivate(){super.onFirstActivate(),this.templatePage.onFirstActivate(this,this.container)}onActivate(){super.onActivate()}onInactivate(){super.onInactivate(),this.templatePage.hide()}setCurrent(){super.setCurrent();const e=this.getCurrentHighlightIndex();null!=e&&-1!==e&&this.itemList.scrollIntoView(e,{block:"start"})}unsetCurrent(){super.unsetCurrent(),this.templatePage&&this.templatePage.hide()}createPageButton(){return w.iconButton("refresh",n.getMessage("buttonContentsRefresh"))}refreshContents(e){const t=this.readPage.readIndex,i=(null==e?t.getContentsTemplate():e)||"";t.setContents(i),this.updateList(),this.indexPage.bookmarkPage.updateList(),this.readPage.textPage.forceUpdate()}pageButtonAction(){this.templatePage.show()}emptyListRender(e){e.appendChild(document.createElement("span")).textContent=n.getMessage("readContentsEmpty")}listItemRender(e,t){e.firstChild||e.appendChild(document.createElement("div")).classList.add("index-contents-item");const i=e.firstChild;i.textContent=t.title,i.lang=this.readPage.langTag}getListItems(){var _this$readPage$index$;return((_this$readPage$index$=this.readPage.index.content)===null||_this$readPage$index$===void 0?void 0:_this$readPage$index$.items)||[]}getCurrentHighlightIndex(){const e=this.readPage.getRenderCursor();return this.readPage.readIndex.getIndexOfContentsByCursor(e)}}class j extends F{constructor(e,t,i,s,n){super(e,t,i,s,n)}createPageButton(){return w.iconButton("bookmark",n.getMessage("buttonBookmarkAdd"))}onFirstActivate(){super.onFirstActivate(),this.dateFormatter=new Intl.DateTimeFormat(navigator.language,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}),this.dateLang=navigator.language}addBookmark(){this.readPage.readIndex.addBookmark(this.readPage.getRenderCursor()),this.updateList()}pageButtonAction(){this.addBookmark()}emptyListRender(e){e.appendChild(document.createElement("span")).textContent=n.getMessage("readBookmarkEmpty")}listItemRender(e,t){if(!e.firstChild){const i=w.create("bookmarkItem");e.appendChild(i.get("root"));const s=i.get("text");s.textContent=t.title,s.lang=this.readPage.langTag;const n=i.get("time");n.textContent=this.dateFormatter.format(t.createTime),n.lang=this.dateLang;const r=this.readPage.readIndex.getContentsByCursor(t.cursor);if(r){const e=i.get("contents");e.textContent=r.title,e.lang=this.readPage.getLang()}}}getListItems(){return Array.from(this.readPage.readIndex.getBookmarkList())}getCurrentHighlightIndex(){const e=this.readPage.readIndex,t=this.readPage.getRenderCursor();return e.getIndexOfBookmarksByCursor(t)}onRemoveItem(e){const t=this.readPage.readIndex,i=t.getIndexOfBookmarksByCursor(e.cursor);-1!==i&&(t.deleteBookmark(e.cursor),this.itemList&&(this.itemList.removeItem(i),this.updateCurrentHighlight()))}}class W extends F{constructor(e,t,i,s,n){super(e,t,i,s,n)}createPageButton(){return w.iconButton("remove",n.getMessage("buttonSearchClear"))}onFirstActivate(){super.onFirstActivate(),this.searchForm=this.container.querySelector(".search-box form"),this.searchInput=this.searchForm.querySelector("input"),this.searchPlaceholder=this.container.querySelector(".search-box-placehodler"),this.searchInput.placeholder=n.getMessage("readSearchPlaceholder"),this.searchButton=w.iconButton("go",n.getMessage("buttonSearchSubmit")),this.searchForm.appendChild(this.searchButton),this.searchButton.classList.add("submit-button"),this.searchButton.type="submit",this.searchForm.addEventListener("submit",e=>{const t=this.searchInput.value;t?this.searchText(t):this.clearSearch(),e.preventDefault(),this.searchPlaceholder.focus()}),this.disablePageButton()}onActivate(){super.onActivate(),this.searchInput.value=""}setCurrent(){super.setCurrent();const e=this.indexPage.tabGroup===document.activeElement;this.itemList.isListEmpty()&&!e&&setTimeout(()=>{this.isCurrent&&this.searchInput.focus()},210)}searchText(e){e&&(this.clearSearch(),this.emptyListSpan.textContent=n.getMessage("readSearchEmpty",e),this.lastSearchText=e,this.lastSearchCursor=0,this.lastSearchLine=0,this.totalSearchHit=0);const t=this.lastSearchText.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,e=>`\\u${e.charCodeAt().toString(16).padStart(4,0)}`),i=new RegExp("("+t+")","i");this.lastSearchReg=i;const s=this.readPage.content.split("\n"),r=s.length,a=this.lastSearchResult;a.pop();const o=a.length;o&&this.itemList.removeItem(o);let l=0,h=this.lastSearchCursor,c=this.lastSearchLine;for(;c<r;c++){if(1e3===l){a.push(null);break}const e=s[c];i.test(e)&&(a.push({cursor:h,line:e}),l++),h+=e.length+1}this.lastSearchLine=c,this.lastSearchCursor=h,this.totalSearchHit+=l,this.itemList.appendList(a.slice(o)),this.enablePageButton()}clearSearch(){this.lastSearchResult=[],this.itemList.setList([]),this.disablePageButton(),this.emptyListSpan.textContent=n.getMessage("readSearchInitial")}pageButtonAction(){this.clearSearch(),this.searchInput.value=""}emptyListRender(e){const t=e.appendChild(document.createElement("span"));t.textContent=n.getMessage("readSearchInitial"),this.emptyListSpan=t}listItemRender(e,t){if(t){const i=this.lastSearchReg,s=e.appendChild(document.createElement("div"));s.classList.add("index-search-item"),s.lang=this.readPage.langTag;const n=t.line,r=n.match(i).index;n.substr(Math.max(r-10,0),200).trim().slice(0,50).split(i).forEach((e,t)=>{t%2==1?s.appendChild(document.createElement("mark")).textContent=e:s.appendChild(document.createTextNode(e))})}else{const t=e.appendChild(document.createElement("div"));t.classList.add("index-search-item","index-search-item-more"),t.textContent=n.getMessage("readSearchTooMany",this.totalSearchHit)}}onItemClick(e){e?super.onItemClick(e):this.searchText()}}class Y extends I{constructor(e,t){super(e,t)}onFirstActivate(){this.contentsPageElement=this.container.querySelector("#read_index_contents"),this.contentsPageTabElement=this.container.querySelector("#read_index_contents_tab"),this.contentsPage=new G(this.contentsPageElement,this.contentsPageTabElement,0,this,this.readPage),this.contentsPageTabElement.appendChild(w.icon("contents",n.getMessage("buttonContents"))),this.bookmarkPageElement=this.container.querySelector("#read_index_bookmark"),this.bookmarkPageTabElement=this.container.querySelector("#read_index_bookmark_tab"),this.bookmarkPage=new j(this.bookmarkPageElement,this.bookmarkPageTabElement,1,this,this.readPage),this.bookmarkPageTabElement.appendChild(w.icon("bookmark",n.getMessage("buttonBookmark"))),this.searchPageElement=this.container.querySelector("#read_index_search"),this.searchPageTabElement=this.container.querySelector("#read_index_search_tab"),this.searchPage=new W(this.searchPageElement,this.searchPageTabElement,2,this,this.readPage),this.searchPageTabElement.appendChild(w.icon("search",n.getMessage("buttonSearch"))),this.subPages=[this.contentsPage,this.bookmarkPage,this.searchPage],this.subPageMap={contents:this.contentsPage,bookmark:this.bookmarkPage,search:this.searchPage},this.currentSubPageIndex=0,this.subPages.forEach(e=>e.onFirstActivate()),this.tabGroupContainer=this.container.querySelector(".index-tab-group"),this.container.addEventListener("scroll",e=>{this.container.scrollLeft=0}),this.tabGroup=this.container.querySelector(".tab-group"),this.tabGroup.addEventListener("keydown",e=>{let t=null;"ArrowRight"===e.code?t=this.subPages[this.currentSubPageIndex+1]:"ArrowLeft"===e.code&&(t=this.subPages[this.currentSubPageIndex-1]),t&&this.setCurrentSubPage(t)})}onActivate(){super.onActivate(),this.subPages.forEach(e=>e.onActivate()),A.disableKeyboardFocus(this.container),this.container.style.setProperty("--slide-offset","0px")}onInactivate(){super.onInactivate(),this.subPages.forEach(e=>e.onInactivate())}slideShow(e,t){const i=this.isCurrent;"move"===e?(this.container.style.setProperty("--slide-offset",`${t}px`),this.container.classList.add("read-index-slide")):"show"!==e||i?(this.container.style.setProperty("--slide-offset","0px"),this.container.classList.remove("read-index-slide"),"hide"===e&&this.hide()):window.requestAnimationFrame(()=>{this.container.style.setProperty("--slide-offset","0px"),this.container.classList.remove("read-index-slide"),this.show()})}setCurrentSubPage(e){this.subPages.forEach(t=>{t!==e&&t.unsetCurrent()}),e.setCurrent();const t=e.pageIndex;this.container.style.setProperty("--tab-index-current",t),this.tabGroup.style.setProperty("--active-index",t),this.currentSubPageIndex=t}show(e=null){const t=this.isCurrent;super.show(),e?this.setCurrentSubPage(this.subPageMap[e]):this.setCurrentSubPage(this.subPages[this.currentSubPageIndex]),A.enableKeyboardFocus(this.container),this.isCurrent!==t&&this.readPage.updateIndexRender(),this.subPages&&this.subPages.forEach(e=>{e.show()})}hide(){const e=this.isCurrent;super.hide(),A.disableKeyboardFocus(this.container),this.isCurrent!==e&&this.readPage.updateIndexRender(),this.subpages&&this.subPages.forEach(e=>{e.hide()})}isSubPageCurrent(e=null){var _this$subPageMap$e;return(_this$subPageMap$e=this.subPageMap[e])===null||_this$subPageMap$e===void 0?void 0:_this$subPageMap$e.isShow}cursorChange(e,t){this.subPages.forEach(e=>{e.cursorChange(t)})}}class K{constructor(e){this.readPage=e,this.readPage.index||(this.readPage.index={id:this.readPage.articleId}),this.index=this.readPage.index,this.index.content&&Array.isArray(this.index.content.items)||(this.index.content={template:"",items:[]}),Array.isArray(this.index.bookmarks)||(this.index.bookmarks=[]),this.config=null,Promise.all([u.expert("text.contents_max_length","number",100),u.expert("text.contents_size_limit","number",2e3)]).then(([e,t])=>{this.config={maxLength:e,limit:t}}),this.content=this.readPage.content}writeIndex(){v.setIndex(this.index)}getBookmarkList(){return this.index.bookmarks}addBookmark(e){const t=this.getBookmarkList();if(t.find(t=>Number(t.cursor)===e))return;const i=t.findIndex(t=>Number(t.cursor)>e),s=this.content.substr(e,200).trim().split("\n")[0].slice(0,50),n={cursor:e,createTime:new Date,title:s};-1===i?t.push(n):t.splice(i,0,n),this.writeIndex()}deleteBookmark(e){const t=this.getIndexOfBookmarksByCursor(e);return-1!==t&&(this.getBookmarkList().splice(t,1),this.writeIndex(),!0)}getIndexOfBookmarksByCursor(e){return this.getBookmarkList().findIndex(t=>t.cursor===e)}getContentsList(){return this.index.content?this.index.content.items:null}getIndexOfContentsByCursor(e){const t=this.getContentsList();if(!t)return null;let i=0,s=t.length-1;for(;i<=s;){const n=Math.floor((i+s)/2);t[n].cursor<=e?i=n+1:s=n-1}return s}getContentsByIndex(e){var _t$e;const t=this.getContentsList();return t?(_t$e=t[e])!==null&&_t$e!==void 0?_t$e:null:null}getContentsByCursor(e){const t=this.getIndexOfContentsByCursor(e);return this.getContentsByIndex(t)}getContentsTemplate(){return this.index.content.template}setContents(e){const t=this.index.content;t.template=e,e&&this.config?(t.items=S.generateContent(this.content,e,this.config),t.items?t.items.unshift({title:this.readPage.meta.title,cursor:0}):t.items=[]):t.items=[],this.writeIndex()}}class X{constructor(e,t){this.outer=e.appendChild(document.createElement("div")),this.outer.classList.add("range-outer"),this.container=this.outer.appendChild(document.createElement("div")),this.inputContainer=this.outer.appendChild(document.createElement("div")),this.input=this.inputContainer.appendChild(document.createElement("input")),this.input.type="number",this.setConfig(t),this.onValueChange=[],this.container.classList.add("range-container"),this.container.setAttribute("role","slider"),this.container.setAttribute("tabindex","0"),this.container.setAttribute("aria-orientation","horizontal"),this.inputContainer.classList.add("range-number-container"),this.input.classList.add("range-number"),this.wrap=this.container.appendChild(document.createElement("div")),this.wrap.classList.add("range-wrap"),this.wrap.setAttribute("tabindex","-1"),this.thumb=this.wrap.appendChild(document.createElement("div")),this.thumb.classList.add("range-thumb"),this.track=this.wrap.appendChild(document.createElement("div")),this.track.classList.add("range-track");const i=e=>{let t=null;const i=this.config;1===e&&(t=i.max),t=0===e?i.min:Math.min(i.max,Math.max(i.min,Math.round((i.max-i.min)*e/i.step)*i.step+i.min)),this.updateValue(t)},s=({position:e})=>{const t=(e[0]-this.track.getClientRects().item(0).x)/this.track.clientWidth;i(Math.min(Math.max(0,t),1))};this.listener=new R(this.container),this.listener.onTouchMove(s),this.listener.onTouchStart(s),this.keyboardHandler=this.keyboardHandler.bind(this),this.container.addEventListener("keydown",this.keyboardHandler),this.wheelHandler=this.wheelHandler.bind(this),this.container.addEventListener("wheel",this.wheelHandler),this.inputHandler=this.inputHandler.bind(this),this.input.addEventListener("input",this.inputHandler),this.input.addEventListener("blur",()=>{this.renderValue(this.value)})}setConfig(e){this.config=this.normalizeConfig(e),this.value=this.normalizeValue(e),this.container.setAttribute("aria-valuemin",this.config.min),this.container.setAttribute("aria-valuemax",this.config.max),this.container.setAttribute("aria-valuenow",this.textValue()),this.input.min=this.config.min,this.input.max=this.config.max,this.input.step=this.config.step,this.input.value=this.textValue()}getConfig(){return this.config}setValue(e){const t=this.normalizeValue(Object.assign({},this.config,{value:Number(e)}));t!==this.value&&(this.value=t,this.renderValue(t))}async updateValue(e){if(this.value===e)return;if(null!=this.updatePendingValue)return void(this.updatePendingValue=e);this.updatePendingValue=e,await new Promise(window.requestAnimationFrame);const t=this.updatePendingValue;this.updatePendingValue=null,this.value=t,this.onValueChange.forEach(e=>{e(this.value)}),this.renderValue()}onChange(e){this.onValueChange.push(e)}renderValue(){const e=this.config,t=(this.value-e.min)/(e.max-e.min);this.container.style.setProperty("--range-ratio",t),this.container.setAttribute("aria-valuenow",this.textValue()),document.activeElement!==this.input&&(this.input.value=this.textValue())}normalizeConfig(e){let t=Number.isFinite(e.min)?e.min:0,i=Number.isFinite(e.max)?e.max:1;t>=i&&([t,i]=[0,1]);let s=Number.isFinite(e.step)?e.step:1;return s<=0&&(s=1),{min:t,max:i,step:s}}normalizeValue(e){return Number.isFinite(e.value)?e.value<=this.config.min?this.config.min:e.value>=this.config.max?this.config.max:Math.round((e.value-this.config.min)/this.config.step)*this.config.step+this.config.min:this.config.min}textValue(){return Number(this.value).toFixed(-Math.round(Math.log(this.config.step)/Math.log(10)))}keyboardHandler(e){var _ArrowUp$ArrowDown$Ar;e.repeat?this.repeatCount++:this.repeatCount=0;const t=1.2**this.repeatCount,i=(_ArrowUp$ArrowDown$Ar={ArrowUp:1,ArrowDown:-1,ArrowRight:1,ArrowLeft:-1,PageUp:10,PageDown:-10}[e.code])!==null&&_ArrowUp$ArrowDown$Ar!==void 0?_ArrowUp$ArrowDown$Ar:0;if(!i)return;const s=(this.config.max-this.config.min)/this.config.step,n=Math.min(t,s/50)*i*this.config.step,r=this.value+n,a=this.normalizeValue(Object.assign({},this.config,{value:r}));this.updateValue(a),e.preventDefault()}inputHandler(e){const t=this.normalizeValue(Object.assign({},this.config,{value:+this.input.value}));this.updateValue(t)}wheelHandler(e){if(!this.container.contains(document.activeElement))return;const t=-Math.sign(e.deltaY);if(1!==Math.abs(t))return;const i=this.value+t*this.config.step,s=this.normalizeValue(Object.assign({},this.config,{value:i}));this.updateValue(s),e.stopPropagation()}dispatch(){this.listener.dispatch(),this.container.remove(),this.input.remove()}}class $ extends I{constructor(e,t){super(e,t)}onFirstActivate(){this.rangeBar=this.container.querySelector("#jump_range"),this.rangeInput=new X(this.rangeBar,{min:0,max:1,step:1}),this.rangeInput.onChange(e=>{this.readPage.setCursor(e,{resetSpeech:!0,resetRender:!0})}),this.coverElement=this.container.querySelector(".read-jump-cover"),this.coverElement.addEventListener("touchstart",e=>{this.hide()},{passive:!0}),this.coverElement.addEventListener("mousedown",e=>{0===e.button&&this.hide()})}onActivate(){super.onActivate(),this.rangeInput.setConfig({min:0,max:this.readPage.content.length,step:1}),this.updateInputValue()}show(){super.show(),this.updateInputValue(),this.rangeBar.focus(),this.readPage.controlPage.disable()}hide(){super.hide(),this.readPage.controlPage.enable()}cursorChange(e,t){this.updateInputValue()}updateInputValue(){const e=this.readPage.getRawCursor();this.rangeInput.setValue(e)}}const J={},Z=J,Q=[],ee=[],te=[],ie=[];let se,ne=null,re=null;const ae=e=>{const t=navigator.languages,i=t.length,s=t.indexOf(e);if(-1!==s)return s;const n=t.map(e=>e.split(/[-_]/)[0]),r=n.indexOf(e.split(/[-_]/)[0]);return-1!==r?i+r:2*i},oe=(e,t)=>ae(e.lang)-ae(t.lang)||e.lang.localeCompare(t.lang)||e.name.localeCompare(t.name),le=function(){ne=speechSynthesis.getVoices(),ne.sort(oe),Q.forEach(e=>{e(ne)}),ee.splice(0).forEach(e=>{e(ne)})};J.onVoiceListChange=function(e){Q.push(e)},J.getVoiceList=function(){return ne},J.getVoiceListAsync=async function(){return null!=ne?ne:new Promise(e=>{ee.push(()=>{e(speechSynthesis.getVoices())})})};const he=function(){let e=null;ne&&se&&(e=ne.find(e=>e.voiceURI===se)),ne&&null===se&&(e=ne.find(e=>e.default),!e&&ne.length&&(e=ne[0])),e!==re&&(re=e,te.forEach(t=>{t(e)}),ie.splice(0).forEach(t=>{t(e)}))};J.onVoiceListChange(he),async function(){se=await u.get("speech_voice")||null,he()}(),u.addListener("speech_voice",e=>{se=e,he()}),J.onPreferVoiceChange=function(e){te.push(e)},J.getPreferVoice=function(){return re},J.getPreferVoiceAsync=async function(){return null!=re?re:new Promise(e=>{ie.push(e)})};let ce=1,de=1;u.get("speech_pitch").then(e=>{ce=Number(e),u.addListener("speech_pitch",e=>{ce=Number(e)})}),u.get("speech_rate").then(e=>{de=Number(e),u.addListener("speech_rate",e=>{de=Number(e)})}),J.prepare=function(e){const t=new SpeechSynthesisUtterance(e);return t.voice=re,t.rate=de,t.pitch=ce,t.lang=re.lang,t},J.setPreferVoice=function(e){u.set("speech_voice",e)},setTimeout(()=>{le();try{speechSynthesis.addEventListener("voiceschanged",le)}catch(e){}},0);class ue{constructor(e){if(ue.instance)return ue.instance.page=e,ue.instance;ue.instance=this,this.page=e,this.onStart=this.onStart.bind(this),this.onBoundary=this.onBoundary.bind(this),this.onEnd=this.onEnd.bind(this),this.onError=this.onError.bind(this),this.onMediaKey=this.onMediaKey.bind(this),this.ssuInfo=new WeakMap,this.listenEvents()}async init(){const e=(e,t)=>e<0?t:Math.round(e);this.speechTextMaxLength=await u.expert("speech.max_char_length","number",1e3,{normalize:e}),this.maxPendingSsuSize=await u.expert("speech.queue_size","number",10,{normalize:e}),this.mediaSessionEnable="mediaSession"in navigator&&await u.expert("speech.media_session_enable","boolean",!1),this.speechTextSkipRegex=await u.expert("speech.skip_text_regex","string",/^\s*$/,{normalize:(e,t)=>{if(/^\/.*\/\w+$/.test(e))try{const t=e.slice(e.indexOf("/")+1,e.lastIndexOf("/")),i=e.slice(e.lastIndexOf("/")+1);return new RegExp(t,i)}catch(e){}try{return new RegExp(e)}catch(e){}return t}}),this.enableLoop=await u.expert("speech.loop_enable","boolean",!1),this.pauseOnHidden=await u.expert("speech.pause_on_hidden","boolean",!1),this.speaking=!1,this.spoken=null,this.speakingSsu=null}listenEvents(){this.listenMediaDeviceChange(),window.addEventListener("beforeunload",e=>{this.stop()}),this.pauseOnHidden&&(this.hiddenPause=!1,document.addEventListener("visibilitychange",e=>{this.speaking&&document.hidden&&(this.hiddenPause=!0,this.stop()),this.hiddenPause&&!document.hidden&&(this.hiddenPause=!1,this.reset())}))}async listenMediaDeviceChange(){if(!navigator.mediaDevices)return!1;if(!navigator.mediaDevices.enumerateDevices)return!1;let e=null;return new Promise(t=>{navigator.mediaDevices.enumerateDevices().then(i=>{e=i.filter(e=>"audiooutput"===e.kind).length,navigator.mediaDevices.addEventListener("devicechange",()=>{navigator.mediaDevices.enumerateDevices().then(t=>{const i=t.filter(e=>"audiooutput"===e.kind).length;i<e&&this.stop(),e=i})}),t(!0)})})}onStart(e){if(!this.speaking)return;const t=e.target,i=this.getSsuInfo(t);if(!i)return;this.speakingSsu=t,this.pendingSsu.delete(t);const s=i.start;this.page.textPage.highlightChars(s,0),this.readMore()}onBoundary(e){if(!this.speaking)return;const t=this.boundaryCursor={},i=e.target,s=this.getSsuInfo(i);if(!s)return;const n=null==e.charIndex?0:e.charIndex,r=null==e.charLength?1/0:e.charLength,a=s.start+n,o=Math.max(0,Math.min(r,s.end-a));Number.isInteger(a)&&Number.isInteger(o)&&a>=0&&o>=0?this.page.textPage.highlightChars(a,o):this.reset(),this.spoken=a,this.boundaryCursor===t&&(this.boundaryCursor=null),this.readMore()}onEnd(e){if(!this.speaking)return;this.speakingSsu=null;const t=e.target;t.removeEventListener("start",this.onStart),t.removeEventListener("boundary",this.onBoundary),t.removeEventListener("end",this.onEnd),t.removeEventListener("error",this.onError);const i=this.getSsuInfo(t);i&&(this.page.textPage?(this.page.textPage.clearHighlight(),this.sopken=i.end,this.readMore()):this.stop())}onError(e){this.speaking&&this.stop()}getSsuInfo(e){const t=this.ssuInfo.get(e);return t||this.reset(),t}readEnd(){this.enableLoop?(this.reset(),this.page.setCursor(0,{resetSpeech:!0,resetRender:!1})):this.stop()}readNext(){const e=this.page.content;let t=null,i=null,s=null;do{if(this.next===e.length)return;t=this.next;const n=e.indexOf("\n",t)+1;s=Math.min(n||e.length,t+this.speechTextMaxLength),this.next=s,i=e.slice(t,s).trimRight()}while(!i||this.speechTextSkipRegex.test(i));const n=Z.prepare(i);this.ssuInfo.set(n,{start:t,end:s}),n.addEventListener("start",this.onStart),n.addEventListener("boundary",this.onBoundary),n.addEventListener("end",this.onEnd),n.addEventListener("error",this.onError),this.pendingSsu.add(n),speechSynthesis.speak(n)}async readMore(){if(this.lastReset)return;if(!this.speaking)return;if(this.readMoreBusy)return;this.readMoreBusy=!0;const e=this.page.content.length;for(;this.speaking&&this.pendingSsu.size<this.maxPendingSsuSize&&this.next<e;)this.readNext(),await new Promise(e=>{setTimeout(e,0)});this.readMoreBusy=!1,this.speaking&&(this.pendingSsu.size||this.speakingSsu||this.readEnd())}spokenInPage(){return null!=this.spoken&&this.page.textPage.isInPage(this.spoken)}async start(){if(this.lastReset)return;if(this.speaking||this.stopping)return;if(speechSynthesis.speaking||speechSynthesis.pending)return;this.readMoreBusy=!1;const e=this.page;e.element.classList.add("read-speech"),this.next=e.getRenderCursor(),null!=this.spoken&&this.spokenInPage()&&(this.next=this.spoken),this.spoken=this.next,this.pendingSsu=new Set,this.speaking=!0,this.mediaSessionEnable&&(this.fakeAudio.currentTime=0,await this.fakeAudio.play(),this.updateMediaSession()),this.readMore()}async stop(){if(!this.speaking)return;if(this.stopping)return void await this.stopping;this.page.element.classList.remove("read-speech"),this.page.textPage.clearHighlight(),this.speaking=!1;let e=null;for(this.stopping=new Promise(t=>{e=t});speechSynthesis.speaking||speechSynthesis.pending;)speechSynthesis.cancel(),await new Promise(e=>setTimeout(e,0));for(this.pendingSsu=null,this.speakingSsu=null;this.readMoreBusy;)await new Promise(e=>setTimeout(e,0));this.stopping=!1,e(),this.mediaSessionEnable&&(this.fakeAudio&&this.fakeAudio.pause(),this.updateMediaSession())}async reset(){const e=this.lastReset={};await this.stop(),await new Promise(e=>setTimeout(e,1e3)),e===this.lastReset&&(this.lastReset=null,await this.start())}async toggle(){this.lastReset||this.stopping||(this.speaking?await this.stop():await this.start())}cursorChange(e,t){if(this.speaking||this.lastReset){if(this.boundaryCursor)return;t.resetSpeech&&this.reset()}else this.spoken=null}metaLoad(e){if(this.stop(),this.metadata=e,!this.mediaSessionEnable)return;this.fakeAudio=new Audio(["data:audio/mp3;base64,","SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU3LjgzLjEwMAAAAAAAAAAAAAAA/+M4AAAAAA","AAAAAAAAAAAAAAAAAASW5mbwAAAA8AAANEAADr+AAEBwkLDhATFRgaHCAjJScqLC8xNDY5","PD9BREZIS01QUlVYW11gYmRnaWxucXR3eXx+gYOFiIqNkJOVmJqdn6Kkpqmtr7G0trm7vs","DCxcnLzdDS1dfa3N/h5efq7O7x8/b4+/0AAAAATGF2YzU3LjEwAAAAAAAAAAAAAAAAJAPA","AAAAAAAA6/hWiK+yAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",`/+MYZAAAAAGkAAAAAAAAA0gAAAAATEFNRTMuMTAw${"V".repeat(56)}`.repeat(336)].join("")),this.fakeAudio.loop=!0,document.body.appendChild(this.fakeAudio),this.updateMediaSession();const t=e=>()=>{this.mediaKey||(this.mediaKey=!0,e?this.start():this.stop(),setTimeout(()=>{this.mediaKey=!1},500))};navigator.mediaSession.setActionHandler("play",t(!0)),navigator.mediaSession.setActionHandler("pause",t(!1)),navigator.mediaSession.setActionHandler("stop",t(!1)),document.addEventListener("keydown",this.onMediaKey)}metaUnload(){this.stop(),this.metadata=null,this.mediaSessionEnable&&(document.removeEventListener("keydown",this.onMediaKey),this.fakeAudio&&(this.fakeAudio.pause(),document.body.removeChild(this.fakeAudio),this.fakeAudio=null),navigator.mediaSession.setActionHandler("play",null),navigator.mediaSession.setActionHandler("pause",null),navigator.mediaSession.setActionHandler("stop",null),this.updateMediaSession())}onMediaKey(e){if(!this.mediaSessionEnable)return;if(this.mediaKey)return;const t=e.key;let i=null;"MediaPlayPause"===t?i=!this.speaking&&!this.stopping:"MediaStop"===t&&(i=!1),null!=i&&(i?this.start():this.stop(),this.mediaKey=!0,setTimeout(()=>{this.mediaKey=!1},500))}updateMediaSession(){if(!this.mediaSessionEnable)return;const e=this.metadata;e?(navigator.mediaSession.metadata=new MediaMetadata({title:e.title}),navigator.mediaSession.playbackState=this.speaking?"playing":"paused",navigator.mediaSession.setPositionState({duration:0,playbackRate:1,position:0})):(navigator.mediaSession.metadata=null,navigator.mediaSession.playbackState="paused",navigator.mediaSession.setPositionState())}isWorking(){return Boolean(this.speaking||this.stopping||this.lastReset)}}class ge extends I{constructor(e,t){super(e,t)}onFirstActivate(){super.onFirstActivate();const e=w.create("header");this.container.insertBefore(e.get("root"),this.container.firstChild);const t=w.iconButton("back",n.getMessage("buttonBack"));e.get("left").appendChild(t),this.bookTitleElement=e.get("mid"),this.backButton=t,this.hide(),this.coverElement=this.container.querySelector(".read-control-cover"),this.coverElement.setAttribute("aria-label",n.getMessage("readControlClose"));const i=this.container.querySelector(".icon-line"),s=(e,t)=>{const s=i.appendChild(document.createElement("div"));return s.classList.add("icon-line-item"),s.appendChild(w.iconButton(e,t))};this.contentsButton=s("contents",n.getMessage("buttonContents")),this.bookmarkButton=s("bookmark",n.getMessage("buttonBookmark")),this.searchButton=s("search",n.getMessage("buttonSearch")),this.jumpButton=s("jump",n.getMessage("buttonJump")),this.speechButton=s("speech",n.getMessage("buttonSpeech"));const r=w.icon("speech-stop",n.getMessage("buttonSpeechStop"));this.speechButton.querySelector(".icon").after(r),[{name:"contents",button:this.contentsButton},{name:"bookmark",button:this.bookmarkButton},{name:"search",button:this.searchButton}].forEach(({name:e,button:t})=>{t.addEventListener("click",t=>{this.hide(),this.readPage.toggleIndexPage(e)})}),this.jumpButton.addEventListener("click",e=>{this.hide(),this.readPage.showJumpPage()}),this.speechButton.addEventListener("click",e=>{this.hide(),this.readPage.toggleSpeech()}),this.backButton.addEventListener("click",e=>{this.readPage.gotoList()}),this.coverElement.addEventListener("touchstart",e=>{e.preventDefault(),window.requestAnimationFrame(()=>{this.hide()})},{passive:!1}),this.coverElement.addEventListener("mousedown",e=>{0===e.button&&window.requestAnimationFrame(()=>{this.hide()})});const a=this.speechButton.closest(".icon-line-item");a.hidden=null==Z.getPreferVoice(),Z.onPreferVoiceChange(e=>{a.hidden=!e}),this.container.addEventListener("focusin",e=>{this.hasFocus=!0,this.container.classList.add("read-control-active")}),this.container.addEventListener("focusout",e=>{this.hasFocus=!1,this.isShow||this.container.classList.remove("read-control-active")})}onActivate(){super.onActivate(),this.bookTitleElement.textContent=this.readPage.getMeta().title,this.bookTitleElement.lang=this.readPage.getLang(),this.hide()}onInactivate(){super.onInactivate(),this.hide()}hide(){var _this$readPage$textPa;this.isShow=!1,this.container.classList.remove("read-control-active"),this.hasFocus&&(this.hasFocus=!1,document.documentElement.focus()),(_this$readPage$textPa=this.readPage.textPage)===null||_this$readPage$textPa===void 0?void 0:_this$readPage$textPa.show()}show(){var _this$readPage$textPa2;this.isShow=!0,this.container.classList.add("read-control-active","read-control-active-init"),(_this$readPage$textPa2=this.readPage.textPage)!==null&&_this$readPage$textPa2!==void 0&&_this$readPage$textPa2.hide(),window.requestAnimationFrame(()=>{this.container.classList.remove("read-control-active-init")})}disable(){this.isEnabled=!1,this.container.classList.add("read-control-disabled")}enable(){this.isEnabled=!0,this.container.classList.remove("read-control-disabled")}focus(){this.backButton.focus()}}const pe={},me=pe,fe=[];pe.addListener=function(e){return-1!==fe.indexOf(e)?null:(fe.push(e),e)},pe.removeListener=function(e){const t=fe.indexOf(e);return-1!==t&&(fe.splice(t,1),!0)};let ve=null,Ce=null,Se=!1;const xe=function(){if(Se)return;const e=document.documentElement,[t,i]=[e.clientWidth,e.clientHeight];t===ve&&i===Ce||(Se=!0,window.requestAnimationFrame(function(){Se=!1;const[t,i]=[e.clientWidth,e.clientHeight];var s;[ve,Ce]=[t,i],s=[t,i],fe.forEach(e=>{e(s)}),window.requestAnimationFrame(xe)}))};xe(),window.addEventListener("load",xe),window.addEventListener("resize",xe),window.addEventListener("orientationchange",xe),document.addEventListener("visibilitychange",xe),pe.currentSize=function(){return[ve,Ce]},pe.isCurrentSizeDirty=function(){return Se};class be{constructor(e){this.readPage=e,this.isCurrent=!1,this.keyboardEvents=this.keyboardEvents.bind(this),this.wheelEvents=this.wheelEvents.bind(this),this.mouseEvents=this.mouseEvents.bind(this),this.onResize=this.onResize.bind(this)}async onActivate({id:e}){this.isCurrent=!0,this.container=this.createContainer(),await this.updateStyleConfig(),this.readPage.container.prepend(this.container),this.useMouseClickPaging=await u.expert("appearance.mouse_paging","boolean",!1),document.addEventListener("keydown",this.keyboardEvents),document.addEventListener("wheel",this.wheelEvents),this.container.addEventListener("mousedown",this.mouseEvents),me.addListener(this.onResize)}createContainer(){return document.createElement("div")}async onInactivate(){this.isCurrent=!1,document.removeEventListener("keydown",this.keyboardEvents),document.removeEventListener("wheel",this.wheelEvents),this.container.removeEventListener("mousedown",this.mouseEvents),this.removeContainer(this.container),this.container=null,this.stepCache=null,me.removeListener(this.onResize)}removeContainer(e){e.remove()}initUpdatePage(){}show(){const e=this.container;e&&(e.classList.remove("read-text-hidden"),e.removeAttribute("aria-hidden"),A.enableKeyboardFocus(e))}hide(){const e=this.container;e&&(e.classList.add("read-text-hidden"),e.setAttribute("aria-hidden","true"),A.enableKeyboardFocus(e))}isInPage(e){return!1}onResize(){this.stepCache=null}forceUpdate(){}keyboardEvents(e){}wheelEvents(e){}mouseEvents(e){}clearHighlight(){}highlightChars(e,t){return!1}cursorChange(e,t){}getRenderCursor(){return this.ignoreSpaces(this.readPage.getRawCursor())}async updateStyleConfig(){this.customFont=document.querySelector("#custom_font"),this.customStyle=document.querySelector("#custom_style");const e=Object.fromEntries(await Promise.all(["light_text","light_background","dark_text","dark_background","font_size","font_family","font_list","line_height","paragraph_spacing"].map(async e=>[e,await u.get(e)]))),t=e.font_family&&Array.isArray(e.font_list)&&e.font_list.find(t=>t.id===e.font_family).content||null;this.customFont.textContent=[t?`@font-face { font-family: "CustomFont"; src: url("${t}"); }`:""].join("\n");const i={"--read-dark-text-color":e.dark_text,"--read-dark-background-color":e.dark_background,"--read-light-text-color":e.light_text,"--read-light-background-color":e.light_background,"--read-font-size":e.font_size+"px","--read-line-height":e.line_height,"--read-paragraph-margin":e.paragraph_spacing*e.line_height*e.font_size+"px","--read-font-family":t?"CustomFont":"auto"},s=Object.keys(i).map(e=>`${e}: ${i[e]};`).join("\n");this.customStyle.textContent=`:root {\n${s}\n}`,this.configs=e;try{await document.fonts.load(`${e.font_size}px CustomFont`)}catch(e){}}ignoreSpaces(e){if(this.ignoreSpacesMemorizeStart===e)return this.ignoreSpacesMemorizeEnd;this.ignoreSpacesMemorizeStart=e;const t=this.readPage.getContent(),i=t.length;let s=e-1;for(;/\s/.test(t[e]);e++)"\n"===t[e]&&(s=e);const n=e>=i?i:s+1;return this.ignoreSpacesMemorizeEnd=n,n}ignoreSpacesBackward(e){const t=this.readPage.getContent();for(;/\s/.test(t[e-1]);)e--;return e}step(){var _this$configs;if(this.stepCache)return this.stepCache;const[e,t]=me.currentSize(),i=e*t,s=(((_this$configs=this.configs)===null||_this$configs===void 0?void 0:_this$configs.font_size)||18)**2;return this.stepCache=Math.floor(i/s),this.stepCache}}class ye extends be{constructor(e){super(e)}async onActivate({id:e}){await super.onActivate({id:e}),this.screenWidthTwoColumn=await u.expert("appearance.screen_width_two_column","number",960),this.screenWidthTwoColumnIndex=await u.expert("appearance.screen_width_two_column_index","number",1260),this.maxContentLength=await u.expert("text.content_max_length","number",100),this.pages={},this.initPrevCursor()}async onInactivate(){await super.onInactivate(),this.pages=null,this.clearPrevCursor()}initUpdatePage(){super.initUpdatePage(),this.updatePages({resetSpeech:!0,resetRender:!1})}clearPrevCursor(){this.prevCursorCache=null}initPrevCursor(){this.prevCursorCache=[new Map,new Map]}getPrevCursor(e){return this.prevCursorCache.reduce((t,i)=>null!=t?t:i.has(e)?i.get(e):null,null)}setPrevCursor(e,t){this.prevCursorCache[0].size>=1e3&&(this.prevCursorCache.pop(),this.prevCursorCache.unshift(new Map)),this.prevCursorCache[0].set(t,e)}createContainer(){const e=w.create("read_text_flip");this.pagesContainer=e.get("pages");const t=new M(this.pagesContainer,{yRadian:Math.PI/5,minDistanceY:60,clickGridX:3}),i=(e,t)=>(...i)=>{this.isAnythingSelected()?t&&t(...i):e(...i)},s=()=>{this.slidePage("cancel")};t.onMoveX(i((e,{touch:t})=>{t?this.slidePage("move",e):s()},s)),t.onSlideLeft(i(({touch:e})=>{e&&this.slidePage("left")},s)),t.onSlideRight(i(({touch:e})=>{e&&this.slidePage("right")},s)),t.onCancelX(s);const r=()=>{this.readPage.slideIndexPage("cancel")};return t.onMoveY(i((e,{touch:t})=>{t?this.readPage.slideIndexPage("move",e):r()},r)),t.onSlideUp(i(({touch:e})=>{e&&(this.readPage.isIndexActive()?this.readPage.slideIndexPage("hide"):this.readPage.showControlPage())},r)),t.onSlideDown(i(({touch:e})=>{e&&this.readPage.slideIndexPage("show")},r)),t.onCancelY(r),t.onTouch(i(({grid:e})=>{const t=e.x;0===t?this.prevPage({resetSpeech:!0,resetRender:!1}):2===t?this.nextPage({resetSpeech:!0,resetRender:!1}):1===t&&this.readPage.showControlPage()})),this.pagesContainer.addEventListener("contextmenu",e=>{this.isAnythingSelected()||(e.preventDefault(),this.readPage.toggleControlPage())},!1),this.prevButton=e.get("prev"),this.prevButton.title=n.getMessage("readPagePrevious"),this.prevButton.addEventListener("click",()=>{this.prevPage({resetSpeech:!0,resetRender:!1})}),this.nextButton=e.get("next"),this.nextButton.title=n.getMessage("readPageNext"),this.nextButton.addEventListener("click",()=>{this.nextPage({resetSpeech:!0,resetRender:!1})}),e.get("root")}removeContainer(e){this.pagesContainer=null,this.prevButton=null,this.nextButton=null,e.remove()}isAnythingSelected(){const e=document.getSelection(),t=this.pages.current.container;for(let i=0;i<e.rangeCount;i++){const s=e.getRangeAt(i);if((s.startContainer!==s.endContainer||s.startOffset!==s.endOffset)&&t.contains(s.startContainer))return!0}return!1}keyboardEvents(e){super.keyboardEvents(e),this.readPage.activedSubpage()||(["PageUp","ArrowLeft"].includes(e.code)?this.prevPage({resetSpeech:!0,resetRender:!1}):["PageDown","ArrowRight"].includes(e.code)?this.nextPage({resetSpeech:!0,resetRender:!1}):["ArrowUp"].includes(e.code)?this.readPage.showControlPage():["ArrowDown"].includes(e.code)&&this.readPage.slideIndexPage("show"))}wheelEvents(e){super.wheelEvents(e);const t=e.target;if(!(t instanceof Element))return;if(!t.closest(".read-text-pages"))return;if(this.wheelBusy)return;const i=e.deltaY;i&&(i>0?this.nextPage({resetSpeech:!0,resetRender:!1}):i<0&&this.prevPage({resetSpeech:!0,resetRender:!1}),setTimeout(()=>{this.wheelBusy=!1},250),this.wheelBusy=!0)}mouseEvents(e){if(this.useMouseClickPaging&&8===e.buttons)this.prevPage({resetSpeech:!0,resetRender:!1});else{if(!this.useMouseClickPaging||16!==e.buttons)return;this.nextPage({resetSpeech:!0,resetRender:!1})}e.preventDefault()}slidePage(e,t){if("move"===e){let e=t;t<0&&!this.pages.next?e=Math.max(-100,t/2):t>0&&!this.pages.prev&&(e=Math.min(100,t/2));const[i,s]=me.currentSize();e=Math.max(-i,Math.min(i,e)),this.pagesContainer.style.setProperty("--slide-x",e+"px"),this.pagesContainer.classList.add("read-text-pages-slide")}else this.pagesContainer.style.setProperty("--slide-x","0px"),this.pagesContainer.classList.remove("read-text-pages-slide");window.requestAnimationFrame(()=>{"left"===e&&this.nextPage({resetSpeech:!0,resetRender:!1}),"right"===e&&this.prevPage({resetSpeech:!0,resetRender:!1})})}slideCancel(){this.slidePage("cancel"),this.readPage.slideIndexPage("cancel")}nextPage(e){this.pages.next&&(this.disposePage(this.pages.prev),this.pages.prev=this.pages.current,this.pages.current=this.pages.next,this.pages.next=null,this.updatePages(e))}prevPage(e){this.pages.prev&&(this.disposePage(this.pages.next),this.pages.next=this.pages.current,this.pages.current=this.pages.prev,this.pages.prev=null,this.updatePages(e))}resetPage(e){this.slideCancel(),this.initPrevCursor(),this.disposePages(),this.updatePages(e)}updatePages(e){this.updatePageBusy=!0;const t=this.readPage.getContent(),i=Math.max(this.readPage.getRawCursor()||0,0),s=this.ignoreSpaces(i),n=this.pages;if(!n.current)if(s<t.length){const e=this.layoutPageStartsWith(i);if(!e)return void this.setCursor(0);n.current=e}else{const e=this.layoutPageEndsWith(t.length);n.current=e}const r=Array.from(n.current.container.querySelectorAll(".read-body"));if(this.readPage.isSpeaking()?r.forEach(e=>{e.removeAttribute("aria-live")}):r.forEach(e=>{const t=e.parentNode,i=document.createElement("span");t.replaceChild(i,e),t.replaceChild(e,i),e.setAttribute("aria-live","polite")}),!n.prev&&n.current.cursor>0)if(null!==this.getPrevCursor(n.current.cursor)){const e=this.getPrevCursor(n.current.cursor);n.prev=this.layoutPageStartsWith(e)}else this.initPrevCursor(),n.prev=this.layoutPageEndsWith(n.current.cursor);this.prevButton.disabled=!n.prev,!n.next&&n.current.nextCursor<t.length&&(n.next=this.layoutPageStartsWith(n.current.nextCursor),this.setPrevCursor(n.current.cursor,n.next.cursor)),this.nextButton.disabled=!n.next,["prev","current","next"].forEach(e=>{const t=n[e];if(!t)return;const i=t.container;i.classList.remove("read-text-page-prev"),i.classList.remove("read-text-page-current"),i.classList.remove("read-text-page-next"),i.classList.add({prev:"read-text-page-prev",current:"read-text-page-current",next:"read-text-page-next"}[e]),i.setAttribute("aria-hidden","current"===e?"false":"true"),this.addRenderedPage(t)}),this.readPage.setCursor(this.pages.current.cursor,e),this.updatePageBusy=!1}disposePage(e){e&&e.container.remove()}disposePages(){this.disposePage(this.pages.prev),this.disposePage(this.pages.current),this.disposePage(this.pages.next),this.pages.prev=null,this.pages.current=null,this.pages.next=null}addRenderedPage(e){e.container.isConnected||this.pagesContainer.appendChild(e.container)}isTwoColumn(){const[e,t]=me.currentSize();return!(e<this.screenWidthTwoColumn||e<this.screenWidthTwoColumnIndex&&this.readPage.isSideIndexActive()||e<1.2*t)}renderContent(e,t){const i=this.readPage.content,s=this.readPage.readIndex,n=this.step();if(null==t.cursor&&(t.cursor=t.start),null==t.previous){const e=i.slice(t.cursor-this.maxContentLength,t.cursor);t.previous=e.slice(e.lastIndexOf("\n")+1)}let r=t.cursor;if(null==t.end?t.cursor=Math.min(t.cursor+n,i.length):t.cursor=Math.min(t.end,i.length),s.getContentsList().length&&null==t.nextSection){const e=s.getContentsList(),i=r-t.previous.length-1,n=Math.max(s.getIndexOfContentsByCursor(i),0)+1;n>=e.length?t.nextSection=0:t.nextSection=n}const a=i.slice(r,t.cursor);return a?(a.split(/(\n)/).forEach(n=>{if(!t.paragraph&&n){const n=t.paragraph=document.createElement("p");if(n.classList.add("text"),n.dataset.start=r,"\n"!==i[r-1]&&n.classList.add("text-truncated-start"),t.nextSection){const e=s.getContentsList();e[t.nextSection].cursor===r-t.previous.length&&(n.setAttribute("role","heading"),n.setAttribute("aria-level","3"),n.classList.add("text-heading"),t.nextSection=(t.nextSection+1)%e.length)}e.insertBefore(n,t.before)}"\n"===n?(t.paragraph=null,t.previous=""):n&&(t.paragraph.textContent+=n,t.previous+=n),r+=n.length}),t):(t.error=!0,t)}layoutPageColumn(e,t){const[i,s]=me.currentSize(),n=this.readPage.content;t.innerHTML="",t.setAttribute("aria-setsize",n.length),t.setAttribute("aria-posinset",e);let r=!1;const a={start:this.ignoreSpaces(e)};for(;!a.error;){if(this.renderContent(t,a),t.clientHeight!==t.scrollHeight){this.renderContent(t,a),r=!0;break}t.clientHeight>4*s&&(a.error=!0)}const o=Array.from(t.querySelectorAll("p[data-start]"));let l;if(r){var _o$slice$reverse$find;const e=t.getBoundingClientRect(),i=(_o$slice$reverse$find=o.slice(0).reverse().find(t=>t.getBoundingClientRect().top<e.bottom))!==null&&_o$slice$reverse$find!==void 0?_o$slice$reverse$find:o[0],s=Number(i.dataset.start),n=i.firstChild;let r=0,a=n?n.textContent.length-1:-1;const h=document.createRange();for(;r<=a;){const t=Math.floor((r+a)/2);h.setStart(n,t),h.setEnd(n,t+1),h.getBoundingClientRect().bottom>e.bottom?a=t-1:r=t+1}let c=null;a<0?c=i.getBoundingClientRect().top-e.top:(h.setStart(n,r-1),h.setEnd(n,r),c=h.getBoundingClientRect().bottom-e.top),l=s+r,t.style.height=c+"px",t.style.bottom="auto"}else l=a.cursor;return o.forEach(e=>{const t=Number(e.dataset.start),i=e.textContent,s=t+i.length;if(t>=l)e.remove();else if(s>l){const s=l-t,n=i.slice(0,s),r=i.slice(s);e.textContent=n;const a=document.createElement("span");a.setAttribute("aria-hidden","true"),a.textContent=r,e.appendChild(a),e.classList.add("text-truncated-end")}}),l}layoutPageStartsWith(e){const t=this.readPage.getContent(),i=this.readPage.readIndex,s=this.ignoreSpaces(e);if(s>=t.length)return null;const n=w.create("read_text_flip_page"),r=n.get("root"),a=n.get("title"),o=n.get("progress");a.textContent=this.readPage.meta.title,r.dataset.title=this.readPage.meta.title;const l=i.getIndexOfContentsByCursor(s);if(-1!==l){r.dataset.section=l;const e=i.getContentsByIndex(l);null!=(e===null||e===void 0?void 0:e.title)&&(a.textContent=e.title)}let h;o.textContent=(s/t.length*100).toFixed(2)+"%",r.lang=this.readPage.getLang(),this.pagesContainer.appendChild(r);const c=n.get("body"),d=n.get("left"),u=n.get("right");if(this.isTwoColumn()){c.remove(),r.classList.add("read-text-two-column");const t=this.layoutPageColumn(e,d);h=this.layoutPageColumn(t,u)}else d.remove(),u.remove(),r.classList.add("read-text-one-column"),h=this.layoutPageColumn(e,c);return this.pagesContainer.removeChild(r),r.classList.remove("read-text-page-processing"),{container:r,cursor:e,nextCursor:h}}layoutPageEndsWith(e){if(!e)return null;const t=w.create("read_text_flip_page"),i=t.get("root");this.pagesContainer.appendChild(i);const s=this.step();this.readPage.getContent(),i.lang=this.readPage.getLang();const n=(e,t)=>{const[i,n]=me.currentSize(),r=this.ignoreSpacesBackward(e);let a=Math.max(r-s,0),o=r;for(;;){const e={start:this.ignoreSpaces(a),end:o,before:t.firstChild};if(this.renderContent(t,e),0===a)break;if(t.clientHeight!==t.scrollHeight)break;if(t.scrollHeight>4*n)break;t.firstChild&&t.firstChild.remove(),t.firstChild&&(o=Number(t.firstChild.dataset.start)),a=Math.max(a-s,0)}if(t.clientHeight===t.scrollHeight)return a;let l=t.getBoundingClientRect().top+t.scrollHeight-t.clientHeight,h=Array.from(t.querySelectorAll("p[data-start]")).find(e=>e.getBoundingClientRect().bottom>l);if(h===t.firstChild){const e=h.nextSibling;h.remove();const i={start:this.ignoreSpaces(Math.max(a-s,0)),end:e?Number(e.dataset.start):r,before:e};this.renderContent(t,i),h=e?e.previousSibling:t.lastChild,l=t.getBoundingClientRect().top+t.scrollHeight-t.clientHeight}const c=Number(h.dataset.start),d=h.firstChild;for(a=0,o=d?d.length-1:-1;a<=o;){var _i$find$top,_i$find;const e=Math.floor((a+o)/2),t=document.createRange();t.setStart(d,e),t.setEnd(d,e+1);const i=Array.from(t.getClientRects());((_i$find$top=(_i$find=i.find(e=>e.width*e.height))===null||_i$find===void 0?void 0:_i$find.top)!==null&&_i$find$top!==void 0?_i$find$top:i[0].top)<l?a=e+1:o=e-1}return this.ignoreSpaces(c+a)};let r;if(this.isTwoColumn()){const i=n(e,t.get("right"));r=n(i,t.get("left"))}else r=n(e,t.get("body"));return this.pagesContainer.removeChild(i),this.layoutPageStartsWith(r)}clearHighlight(){Array.from(document.querySelectorAll(".read-highlight")).forEach(e=>{e.innerHTML=""}),this.lastHighlightStart=null,this.lastHighlightLength=null}highlightChars(e,t,i=0){var _this$pages$prev,_this$pages$next,_this$pages$next2;if(this.updatePageBusy)return null;if(this.lastHighlightStart===e&&this.lastHighlightLength===t)return null;if(this.clearHighlight(),i>3)return null;if(!this.pages.current)return this.readPage.setCursor(e,{resetSpeech:!1,resetRender:!0}),this.highlightChars(e,t,i+1);const s=(_this$pages$prev=this.pages.prev)===null||_this$pages$prev===void 0?void 0:_this$pages$prev.nextCursor,n=this.pages.current.cursor,r=this.pages.current.nextCursor,a=(_this$pages$next=this.pages.next)===null||_this$pages$next===void 0?void 0:_this$pages$next.cursor,o=(_this$pages$next2=this.pages.next)===null||_this$pages$next2===void 0?void 0:_this$pages$next2.nextCursor;if(e+t<Math.min(n,s!==null&&s!==void 0?s:0))return this.readPage.setCursor(e,{resetSpeech:!1,resetRender:!1}),this.highlightChars(e,t,i+1);if(e>=a)return e<o?this.nextPage({resetSpeech:!1,resetRender:!1}):this.readPage.setCursor(e,{resetSpeech:!1,resetRender:!1}),this.highlightChars(e,t,i+1);if(this.lastHighlightStart=e,this.lastHighlightLength=t,e>r||0===t)return[];const l=this.pages.current.container,h=Array.from(l.querySelectorAll("p[data-start]")).reverse().find(t=>t.dataset.start<=e);if(!h)return!1;const c=document.createRange(),d=Number(h.dataset.start),u=h.firstChild;if(!u)return!1;const g=u.textContent.length,p=e-d;if(p>=g)return p===g;const m=Math.min(p+t,g);c.setStart(u,p),c.setEnd(u,m);const f=l.querySelector(".read-highlight"),v=l.getBoundingClientRect(),C=Array.from(c.getClientRects()).filter(e=>e.width*e.height),S=Number.parseFloat(window.getComputedStyle(c.startContainer.parentNode).lineHeight),[x,b]=me.currentSize();return C.map(e=>{if(e.top>b)return null;if(e.left>x)return null;const t=Math.min(e.height,S-1),i=document.createElement("span");return i.style.left=e.left-v.left+"px",i.style.width=e.width+"px",i.style.top=(e.top+e.bottom-t)/2-v.top+"px",i.style.height=t+"px",f.appendChild(i),i}).filter(e=>null!=e).length>0}forceUpdate(){this.resetPage({resetSpeech:!0,resetRender:!0})}isInPage(e){const t=this.pages.current;if(!t)return!1;const i=this.pages.prev,s=i?i.nextCursor:1/0,n=t.cursor;if(e<Math.min(s,n))return!1;const r=this.pages.next,a=r?r.cursor:0,o=t.nextCursor;return!(e>=Math.max(o,a))}cursorChange(e,t){const i=this.pages.current;i&&i.cursor===e||this.resetPage(t)}onResize(){super.onResize(),this.resetPage({resetSpeech:!1,resetRender:!0})}}class Pe extends be{constructor(e){super(e),this.autoScrollOnVisibilityChange=this.autoScrollOnVisibilityChange.bind(this)}async onActivate({id:e}){await super.onActivate({id:e}),this.textBufferSize=await u.expert("appearance.scroll_buffer_factor","number",3)||3,this.maxTextWidth=await u.expert("appearance.scroll_max_text_width","number",0),this.minimumBufferHeight=500,this.scrollDoneTimeout=500,this.scrollToTimeout=500,this.updateMetaTimeout=250,this.doubleTapTimeout=400,this.maxTrunkLength=65536,this.readSpeedBase=await u.expert("appearance.scroll_speed","number",20)||20,this.readSpeedFactorMin=.1,this.readSpeedFactorMax=20,this.maxTextWidth&&this.readScrollElement.parentNode.style.setProperty("--text-max-width",this.maxTextWidth+"px")}async onInactivate(){await super.onInactivate(),this.trunks=null,this.activeParagraphs=null,this.readBodyElement=null,this.readScrollElement=null,this.titleElement=null,this.progressElement=null,this.currentScrollPosition=null,this.scrollActive=null,this.scrollToBusy=null,this.autoScrollStop(),this.autoScrollSpeedFactor=null,this.textAreaOffset=null}initUpdatePage(){super.initUpdatePage(),this.updatePaddingArea(),this.updatePage({resetSpeech:!0,resetRender:!0})}createContainer(){const e=w.create("read_text_scroll");this.readBodyElement=e.get("body"),this.readScrollElement=e.get("scroll"),this.titleElement=e.get("title"),this.progressElement=e.get("progress"),this.highlightContainer=e.get("highlight"),this.autoScrollCover=e.get("cover"),this.autoScrollCover.setAttribute("aria-label",n.getMessage("readAutoScrollStop")),this.readScrollElement.addEventListener("scroll",e=>{this.onScroll()},{passive:!0,capture:!0}),this.trunks=[],this.activeParagraphs=[];const t=new M(this.readScrollElement,{yRadian:4*Math.PI/5,minDistanceX:60,clickGridY:3}),i=()=>{this.scrollToBusy&&this.abortScrollTo(),this.readScrollElement.classList.add("read-body-scroll-slide-x"),this.scrollActive&&this.onScrollDone()},s=()=>{this.readScrollElement.classList.remove("read-body-scroll-slide-x")};t.onMoveX((e,{touch:t})=>{t&&(i(),this.isAnythingSelected()?this.readPage.slideIndexPage("cancel"):this.readPage.slideIndexPage("move",e))}),t.onSlideLeft(({touch:e})=>{e&&(s(),this.isAnythingSelected()?this.readPage.slideIndexPage("cancel"):this.readPage.isIndexActive()?this.readPage.slideIndexPage("hide"):this.readPage.showControlPage())}),t.onSlideRight(({touch:e})=>{e&&(s(),this.isAnythingSelected()?this.readPage.slideIndexPage("cancel"):this.readPage.slideIndexPage("show"))}),t.onCancelX(({touch:e})=>{e&&(s(),this.readPage.slideIndexPage("cancel"))}),t.onTouch(({touch:e,grid:t})=>{var _this$touchCount;this.autoScrollBusy()||(this.touchCount=((_this$touchCount=this.touchCount)!==null&&_this$touchCount!==void 0?_this$touchCount:0)+1,0===t.y?this.pageUp({resetSpeech:!0,resetRender:!1}):2===t.y?this.pageDown({resetSpeech:!0,resetRender:!1}):1===t.y&&(this.readPage.showControlPage(),this.justShowControlPage=!0,setTimeout(()=>{this.justShowControlPage=!1},this.doubleTapTimeout)))}),this.readScrollElement.addEventListener("contextmenu",e=>{this.isAnythingSelected()||this.autoScrollRunning||(e.preventDefault(),this.readPage.toggleControlPage())},!1),this.readScrollElement.addEventListener("dblclick",e=>{const t=e.clientY/this.readScrollElement.clientHeight;1===Math.floor(3*t)&&(this.readPage.hideControlPage(),this.autoScrollStart())}),this.readBodyElement.addEventListener("transitionend",()=>{window.requestAnimationFrame(()=>{this.onScrollToEnd()})});const r=new M(this.autoScrollCover,{clickGridY:3});return r.onStart(()=>{this.autoScrollRunning&&(this.autoScrollSpeedFactorOld=this.autoScrollSpeedFactor)}),r.onMoveY(e=>{if(!this.autoScrollRunning)return;const[t,i]=me.currentSize(),s=Math.abs(e)>r.minDistanceY?(1/16)**(e/i):1,n=this.autoScrollSpeedFactorOld*s;this.autoScrollUpdate({speedFactor:n})}),r.onEnd(()=>{this.autoScrollRunning&&(this.autoScrollSpeedFactorOld=null)}),r.onTouch(({grid:e})=>{this.autoScrollRunning&&(0===e.y?(this.autoScrollStop({paging:!0}),this.pageUp({resetSpeech:!0,resetRender:!1})):1===e.y?this.autoScrollStop():(this.autoScrollStop({paging:!0}),this.pageDown({resetSpeech:!0,resetRender:!1})))}),this.autoScrollCover.addEventListener("wheel",e=>{if(!this.autoScrollRunning)return;const[t,i]=me.currentSize(),s=2**(e.deltaY/i),n=this.autoScrollSpeedFactor*s;this.autoScrollUpdate({speedFactor:n})},{passive:!0}),this.prevButton=e.get("prev"),this.prevButton.title=n.getMessage("readPageScrollUp"),this.prevButton.addEventListener("click",()=>{this.pageUp({resetSpeech:!0,resetRender:!1})}),this.nextButton=e.get("next"),this.nextButton.title=n.getMessage("readPageScrollDown"),this.nextButton.addEventListener("click",()=>{this.pageDown({resetSpeech:!0,resetRender:!1})}),e.get("root")}updatePaddingArea(){const e=window.getComputedStyle(this.readScrollElement),t=window.getComputedStyle(this.readBodyElement),i=(e,t)=>Number.parseInt(e.getPropertyValue(t),10),s=s=>i(e,s)+i(t,s);this.textAreaOffset={top:0+s("padding-top"),bottom:0+s("padding-bottom"),left:0+s("padding-left"),right:0+s("padding-right")}}fixIosScrollReset(){if(this.scrollToBusy)return;let e=this.readScrollElement.scrollTop;Math.abs(e-this.lastScrollTop)<this.getTextBufferHeight()||this.setScrollTop(this.lastScrollTop)}onScroll(){const e=this.lastScrollEvent={};this.scrollToBusy||this.readScrollElement.scrollTop!==this.lastScrollTop&&(me.isCurrentSizeDirty()||(this.scrollActive=!0,this.onScrollScheduled||(this.fixIosScrollReset(),this.onScrollScheduled=!0,window.requestAnimationFrame(()=>{this.onScrollScheduled=!1,this.updatePage({resetSpeech:!1,resetRender:!1,debug:!0}),setTimeout(()=>{if(e!==this.lastScrollEvent)return;const t=this.readPage.speech;this.onScrollDone({resetSpeech:t.isWorking()&&!t.spokenInPage(),resetRender:!1})},this.scrollDoneTimeout)}))))}onScrollDone(e){this.scrollActiveFinishing=!0,this.scrollActive=!1,this.updatePage(e),this.scrollActiveFinishing=!1}onScrollToEnd(){if(!this.scrollToBusy)return;const e=this.readScrollElement,t=this.readBodyElement;e.classList.remove("read-body-scroll-to"),t.style.top="";const i=this.scrollToBusy;requestAnimationFrame(()=>{this.pageBusy&&this.pageDone(),this.onScrollDone(this.scrollToConfig),i===this.scrollToBusy&&(this.scrollToBusy=null)})}abortScrollTo(){if(!this.scrollToBusy)return;const e=this.readScrollElement,t=this.readBodyElement,i=Number.parseInt(window.getComputedStyle(t).top,10);this.setScrollTop(e.scrollTop-i),this.onScrollToEnd()}scrollTo(e,t){if(this.autoScrollRunning)return!1;const i=this.readScrollElement,s=this.readBodyElement,n=i.scrollTop,r=i.scrollHeight-i.clientHeight,a=Math.max(0,Math.min(e,r))-n;if(!a)return!1;this.scrollActive=!0,this.scrollToBusy&&this.abortScrollTo();const o=this.scrollToBusy={};return this.scrollToConfig=t,this.setScrollTop(e),this.updatePageRender(),s.style.top=a+"px",i.classList.add("read-body-scroll-to"),window.requestAnimationFrame(()=>{window.getComputedStyle(s).transitionProperty,o===this.scrollToBusy&&(s.style.top="0",setTimeout(()=>{o===this.scrollToBusy&&this.abortScrollTo()},this.scrollToTimeout))}),!0}removeContainer(e){e.remove(),this.readBodyElement=null,this.titleElement=null,this.progressElement=null,this.trunks=null,this.activeParagraphs=null,this.currentScrollPosition=null,this.textAreaOffset=null}isAnythingSelected(){const e=document.getSelection(),t=this.readScrollElement;for(let i=0;i<e.rangeCount;i++){const s=e.getRangeAt(i);if((s.startContainer!==s.endContainer||s.startOffset!==s.endOffset)&&t.contains(s.startContainer))return!0}return!1}keyboardEvents(e){if(!this.readPage.activedSubpage()){if(["PageUp","PageDown"].includes(e.code))window.requestAnimationFrame(()=>{this.autoScrollRunning?(this.autoScrollStop({paging:!0}),"PageUp"===e.code?this.pageUp({resetSpeech:!0,resetRender:!1}):this.pageDown({resetSpeech:!0,resetRender:!1})):this.autoScrollBusy()||("PageUp"===e.code?this.pageUp({resetSpeech:!0,resetRender:!1}):this.pageDown({resetSpeech:!0,resetRender:!1}))});else if(["ArrowLeft"].includes(e.code))this.autoScrollRunning||this.autoScrollPaging||this.readPage.showControlPage();else if(["ArrowRight"].includes(e.code))this.autoScrollRunning||this.autoScrollPaging||this.readPage.slideIndexPage("show");else if(["ArrowUp","ArrowDown"].includes(e.code)){if(this.autoScrollRunning){const t="ArrowUp"===e.code?-1:1,i=this.autoScrollSpeedFactor*1.1**t;this.autoScrollUpdate({speedFactor:i})}}else if(["Home","End"].includes(e.code));else{if(!["Escape"].includes(e.code)||!this.autoScrollBusy())return;this.autoScrollStop()}e.preventDefault(),e.stopPropagation()}}mouseEvents(e){if(this.useMouseClickPaging&&8===e.buttons)this.pageUp({resetSpeech:!0,resetRender:!1});else{if(!this.useMouseClickPaging||16!==e.buttons)return;this.pageDown({resetSpeech:!0,resetRender:!1})}e.preventDefault()}isScrollReachTop(){const{scrollTop:e}=this.readScrollElement;return 0===e}isScrollReachBottom(){const{scrollTop:e,scrollHeight:t,clientHeight:i}=this.readScrollElement;return e>=t-i-1}pageUp(e){if(this.pageBusy)return void(this.pagePending={direction:"up",config:e});const t=this.scrollToBusy||this.readPage.speech.isWorking()||this.autoScrollBusy();if(this.isScrollReachTop()&&!t)return void this.readPage.showControlPage();const i=this.getPageStartPosition();if(!i)return;const s=i.paragraph,n=this.getTextPosition(s,i.offset,"bottom"),[r,a]=me.currentSize(),o=a-this.textAreaOffset.bottom-n,l=this.readScrollElement.scrollTop-o;this.pageTo(l,e,"up")}pageDown(e){if(this.pageBusy)return void(this.pagePending={direction:"down",config:e});const t=this.scrollToBusy||this.readPage.speech.isWorking()||this.autoScrollBusy();if(this.isScrollReachBottom()&&!t)return void this.readPage.showControlPage();this.lastPageDown=performance.now();const i=this.getPageEndPosition();if(!i)return;const s=i.paragraph,n=Math.min(i.offset,s.last-s.start-1),r=this.getTextPosition(s,n,"top"),a=this.textAreaOffset.top-r,o=this.readScrollElement.scrollTop-a;this.pageTo(o,e,"down")}pageDone(){var _this$pagePending;this.pageBusy&&((_this$pagePending=this.pagePending)===null||_this$pagePending===void 0?void 0:_this$pagePending.direction)===this.pageBusy?this.readScrollElement.classList.add("read-body-scroll-fast"):this.readScrollElement.classList.remove("read-body-scroll-fast"),this.pageBusy=null,this.pagePending&&("up"===this.pagePending.direction?this.pageUp(this.pagePending.config):"down"===this.pagePending.direction&&this.pageDown(this.pagePending.config)),this.pagePending=null,this.pageBusy||this.autoScrollPaging&&window.requestAnimationFrame(()=>{this.autoScrollStart()})}pageTo(e,t,i){this.pageBusy=i,this.scrollTo(e,t)||(this.pageBusy=null)}setScrollTop(e){const t=this.readScrollElement,i=e;t.scrollTop!==i&&(t.scrollTop=i),this.lastScrollTop=t.scrollTop}getParagraphByCursor(e){const t=t=>{let i=0,s=t.length-1;if(!t.length)return null;if(e<t[i].start)return null;if(e>=t[s].end)return null;for(;;){const n=Math.floor((i+s)/2),r=t[n];if(e>=r.end)i=n+1;else{if(!(e<r.start))return r;s=n-1}}},i=t(this.trunks);return i&&t(i.paragraphs)}clearPage(){this.scrollActive=!1,this.trunks.splice(0).forEach(e=>e.element.remove()),this.setScrollTop(0)}renderParagraph(e,t,{start:i,end:s,last:n,heading:r,trucked:a}){const o=document.createElement("p");o.classList.add("text"),a.start&&o.classList.add("text-trucked-start"),a.end&&o.classList.add("text-trucked-end"),o.textContent=e,Object.assign(o.dataset,{start:i,end:s}),r&&(o.setAttribute("role","heading"),o.setAttribute("aria-level","3"),o.classList.add("text-heading")),t.element.appendChild(o);const l={start:i,end:s,last:n,element:o,trunk:t,prev:null,next:null};return t.paragraphs.length&&(l.prev=t.paragraphs[t.paragraphs.length-1],t.paragraphs[t.paragraphs.length-1].next=l),t.paragraphs.push(l),l}updateTrunkOffsetTop(){let e=0;this.trunks.forEach(t=>{t.offsetTop=e,e+=t.height})}renderTrunk(e,t,i){const s=this.readPage.getContent(),n=this.readPage.readIndex,r=document.createElement("div"),a={element:r,paragraphs:[],start:e,end:t};r.classList.add("trunk"),Object.assign(r.dataset,{start:e,end:t}),0===e&&r.classList.add("trunk-first"),t===s.length&&r.classList.add("trunk-last");let o=n.getIndexOfContentsByCursor(e);0===o&&(o=1);let l=n.getContentsByIndex(o);l&&l.cursor<e&&++o;for(let i=e,r=e;i<t;r=i){var _n$getContentsByIndex;const e=((_n$getContentsByIndex=n.getContentsByIndex(o))===null||_n$getContentsByIndex===void 0?void 0:_n$getContentsByIndex.cursor)===r,l=i=s.indexOf("\n",i);-1===i?i=s.length:++i,i>t&&(i=t);const h=i===l+1?l:i,c=s.slice(r,h),d={start:0!==r&&"\n"!==s[r-1],end:i!==s.length&&"\n"!==s[i-1]};this.renderParagraph(c,a,{start:r,last:h,end:i,heading:e,trucked:d}),o+=e}const h=this.readBodyElement,c="first"===i?h.firstChild:h.lastChild;h.insertBefore(r,c);const d=r.getBoundingClientRect();if(a.height=Math.round(1e3*d.height)/1e3,a.paragraphs.forEach(e=>{const t=e.element.getBoundingClientRect();e.height=Math.round(1e3*t.height)/1e3,e.offsetTop=Math.round(1e3*(t.top-d.top))/1e3}),r.style.height=a.height+"px","first"===i){if(this.trunks.length){const e=this.trunks[0];a.next=e,e.prev=a;const t=e.paragraphs[0],i=a.paragraphs[a.paragraphs.length-1];i.next=t,t.prev=i}this.trunks.unshift(a)}else{if(this.trunks.length){const e=this.trunks[this.trunks.length-1];a.prev=e,e.next=a;const t=e.paragraphs[e.paragraphs.length-1],i=a.paragraphs[0];t.next=i,i.prev=t}this.trunks.push(a)}return this.updateTrunkOffsetTop(),a}removeTrunk(e){if(0===this.trunks.length)return null;const t="first"===e?this.trunks.shift():this.trunks.pop();if(t.element.remove(),t.next){const e=t.next;t.next=null,e.prev=null,t.paragraphs[t.paragraphs.length-1].next=null,e.paragraphs[0].prev=null}if(t.prev){const e=t.prev;t.prev=null,e.next=null,t.paragraphs[0].prev=null,e.paragraphs[e.paragraphs.length-1].next=null}return"first"===e&&this.updateTrunkOffsetTop(),t}getTrunkEndPosition(e){const t=this.readPage.getContent();let i=t.indexOf("\n",e+this.step());-1===i?i=t.length:++i;const s=Math.max(this.maxTrunkLength,4*this.step());return i-e>s&&(i=t.lastIndexOf("\n",e+this.step()),i<=e?i=e+Math.floor(s/2):++i),i}getTrunkStartPosition(e){let t=this.readPage.getContent().lastIndexOf("\n",e-this.step())+1;for(;;){const i=this.getTrunkEndPosition(t);if(!(i<e))return t;t=i}}renderTrunkStartsWith(e,t){const i=this.getTrunkEndPosition(e);return this.renderTrunk(e,i,t)}renderTrunkEndsWith(e,t){const i=this.getTrunkStartPosition(e);return this.renderTrunk(i,e,t)}renderTrunkContains(e,t){const i=this.getTrunkStartPosition(e+1),s=this.getTrunkEndPosition(i);return this.renderTrunk(i,s,t)}getTextPosition(e,t,i){var _o$find;const s=e.element,n=e.last-e.start;if(t<0)return s.getBoundingClientRect().top;if(t>=n)return s.getBoundingClientRect().bottom;const r=s.firstChild,a=document.createRange();a.setStart(r,t),a.setEnd(r,t+1);const o=Array.from(a.getClientRects()),l=(_o$find=o.find(e=>e.width*e.height))!==null&&_o$find!==void 0?_o$find:o[0];return"top"===i?l.top:l.bottom}getScrollPosition(e,t){var _n$paragraphs;const i=e-this.textAreaOffset.top,s=(e,i)=>{if(!e.length)return null;const s=e.length;let n=0,r=s-1;for(;n<=r;){const s=Math.floor((n+r)/2),a=e[s];(t?a.offsetTop<=i:a.offsetTop+a.height<i)?n=s+1:r=s-1}const a=t?r:n;return a<0?e[0].prev:a===s?e[s-1].next:e[a]},n=s(this.trunks,i);if(!(n!==null&&n!==void 0&&(_n$paragraphs=n.paragraphs)!==null&&_n$paragraphs!==void 0&&_n$paragraphs.length))return null;const r=s(n.paragraphs,i-n.offsetTop),a=r.element,o=r.offsetTop+r.trunk.offsetTop;let l=0,h=r.last-r.start;const c=i-o+a.getBoundingClientRect().top;for(;l<=h;){const e=Math.floor((l+h)/2);this.getTextPosition(r,e,t?"bottom":"top")<c?l=e+1:h=e-1}const d=t?h:l,u=r.start+d;let g=u<r.start?r.prev:u>=r.end?r.next:r;return g?{paragraph:g,cursor:u,offset:u-g.start}:null}getPageStartPosition(){const e=this.readBodyElement.getBoundingClientRect(),t=this.textAreaOffset.top-e.top;return this.getScrollPosition(t-2,!1)}getPageEndPosition(){const[e,t]=me.currentSize(),i=this.readBodyElement.getBoundingClientRect(),s=t-this.textAreaOffset.bottom-i.top;return this.getScrollPosition(s,!0)}getRenderCursor(){var _this$currentRenderCu;return(_this$currentRenderCu=this.currentRenderCursor)!==null&&_this$currentRenderCu!==void 0?_this$currentRenderCu:super.getRenderCursor()}getTextBufferHeight(){const[e,t]=me.currentSize();return Math.max(t,this.minimumBufferHeight)*this.textBufferSize}updatePagePrev(){const e=this.trunks,t=this.getTextBufferHeight();let i=0,s=!1,n=this.currentTrunk.offsetTop;const r=4*t;if(n<t*(this.scrollActive?2:4))do{const t=e[0].start;if(0===t)break;const r=this.renderTrunkEndsWith(t,"first");n+=r.height,i+=r.height,s=!0}while(!this.scrollActive&&n<r);const a=6*t;if(n>t*(this.scrollActive?12:8))for(;n-e[0].height>a;){const e=this.removeTrunk("first");n-=e.height,i-=e.height,s=!0}return s?i:null}updatePageCurrent(){var _this$readPage$getRaw;const e=this.readPage.getContent(),t=this.getPageStartPosition();if(t){const e=t.paragraph;return this.currentTrunk=e.trunk,this.currentRenderCursor=t.cursor,this.readScrollElement.scrollTop}this.clearPage();const i=(_this$readPage$getRaw=this.readPage.getRawCursor())!==null&&_this$readPage$getRaw!==void 0?_this$readPage$getRaw:0;if(this.currentRenderCursor=i,i<e.length){const e=this.renderTrunkContains(i,"first");this.currentTrunk=e;const t=e.paragraphs.find(e=>e.end>i);return this.getTextPosition(t,i-t.start,"top")-e.element.getBoundingClientRect().top}{const e=this.renderTrunkEndsWith(i,"first");return this.currentTrunk=e,e.height}}updatePageNext(){const e=this.readPage.getContent(),t=this.trunks,i=this.getTextBufferHeight();let s=0,n=!1;const r=t[t.length-1];let a=r.offsetTop+r.height-(this.currentTrunk.offsetTop+this.currentTrunk.height);const o=10*i;if(a<i*(this.scrollActive?6:10))do{const i=t[t.length-1].end;if(i>=e.length)break;const r=this.renderTrunkStartsWith(i,"last");a+=r.height,s+=r.height,n=!0}while(!this.scrollActive&&a<o);const l=12*i;if(a>i*(this.scrollActive?16:12))for(;a-t[t.length-1].height>l;){const e=this.removeTrunk("last");a-=e.height,s-=e.height,n=!0}return n?s:null}updatePageMeta(){var _this$readPage$readIn,_this$readPage$readIn2;const e=this.readPage.getContent().length,t=this.currentRenderCursor,i=(t/e*100).toFixed(2)+"%",s=(_this$readPage$readIn=(_this$readPage$readIn2=this.readPage.readIndex.getContentsByCursor(t))===null||_this$readPage$readIn2===void 0?void 0:_this$readPage$readIn2.title)!==null&&_this$readPage$readIn!==void 0?_this$readPage$readIn:this.readPage.getMeta().title;this.titleElement.textContent!==s&&(this.titleElement.textContent=s),this.progressElement.textContent!==i&&(this.progressElement.textContent=i)}updatePageRender(){const e=this.updatePageCurrent(),t=this.updatePagePrev(),i=null!=t&&this.scrollActive?null:this.updatePageNext();null==t&&null==i||null!=this.lastHighlightStart&&this.resetHighlightChars();const s=e+(t!==null&&t!==void 0?t:0);this.setScrollTop(s),t&&this.autoScrollBusy()&&this.autoScrollUpdate({scrollDelta:t})}async updatePage(e){this.updatePageRender();const t={},i=()=>{if(this.updatePageMetaScheduled===t&&(this.updatePageMetaScheduled=!1,this.updatePageMeta(),!this.scrollActive||this.autoScrollBusy())){var _this$readPage$getRaw2;const t=this.currentRenderCursor;((_this$readPage$getRaw2=this.readPage.getRawCursor())!==null&&_this$readPage$getRaw2!==void 0?_this$readPage$getRaw2:0)!==t&&this.readPage.setCursor(t,e)}};if(this.scrollActive){if(this.updatePageMetaScheduled)return;this.updatePageMetaScheduled=t,window.requestIdleCallback?setTimeout(()=>{window.requestIdleCallback(i,{timeout:this.updateMetaTimeout/2})},this.updateMetaTimeout/2):setTimeout(i,this.updateMetaTimeout)}else this.updatePageMetaScheduled=t,i()}clearHighlight(){this.highlightContainer.replaceChildren(),this.lastHighlightStart=null,this.lastHighlightLength=null}highlightChars(e,t,i=0){if(this.lastHighlightStart===e&&this.lastHighlightLength===t)return null;const s=s=>this.scrollActive||this.scrollActiveFinishing||this.scrollToBusy?null:(s?this.pageDown({resetSpeech:!1,resetRender:!1}):this.readPage.setCursor(e,{resetSpeech:!1,resetRender:!0}),this.highlightChars(e,t,i+1));if(this.clearHighlight(),i>3)return null;const n=this.getParagraphByCursor(e);if(!n)return this.scrollToBusy?null:s(!1);if(this.lastHighlightStart=e,this.lastHighlightLength=t,Math.min(e+t,n.last)<=e)return[];const r=this.highlightContainer.getBoundingClientRect(),a=me.currentSize()[1],o=document.createRange(),l=n.element.firstChild;o.setStart(l,e-n.start),o.setEnd(l,Math.min(e+t,n.last)-n.start);const h=Array.from(o.getClientRects()).filter(e=>e.width*e.height),c=Number.parseFloat(window.getComputedStyle(o.startContainer.parentNode).lineHeight),d=h.map(e=>{const t=Math.min(e.height,c-1),i=document.createElement("span");return i.style.left=e.left-r.left+"px",i.style.width=e.width+"px",i.style.top=(e.top+e.bottom-t)/2-r.top+"px",i.style.height=t+"px",this.highlightContainer.appendChild(i),i}),u=h.find(e=>h.every(t=>t.top>=e.top));if(!this.scrollToBusy){if(u.bottom<this.textAreaOffset.top)return s(!1);if(u.bottom>a-this.textAreaOffset.bottom)return s(!(u.bottom-(a-this.textAreaOffset.bottom)>a/2))}return d}resetHighlightChars(){if(null==this.lastHighlightStart)return;const e=this.lastHighlightStart,t=this.lastHighlightLength;this.clearHighlight(),this.highlightChars(e,t)}forceUpdate(){this.resetPage({resetSpeech:!0,resetRender:!0})}isInPage(e){const t=this.getPageStartPosition();if(!t||e<t.cursor)return!1;const i=this.getPageEndPosition();return!(!i||e>i.cursor)}cursorChange(e,t){if(this.currentRenderCursor===e)return;const i=this.getParagraphByCursor(e);if(!i||t.resetRender)this.resetPage(t);else{const s=this.getTextPosition(i,e-i.start,"top")-this.textAreaOffset.top,n=this.readScrollElement.scrollTop;this.scrollTo(n+s,t)}}resetPage(e){this.autoScrollBusy()&&this.autoScrollUpdate({}),this.clearPage(),this.clearHighlight(),this.currentRenderCursor=null,this.updatePage(e),this.autoScrollBusy()&&this.autoScrollUpdate({reset:!0})}onResize(){super.onResize(),this.updatePaddingArea(),this.resetPage({resetSpeech:!1,resetRender:!0})}step(){return 2*super.step()}hide(){super.hide(),this.justShowControlPage&&(this.justShowControlPage=!1,this.autoScrollStart())}autoScrollStart(){if(this.readPage.isSpeaking())return;if(this.autoScrollRunning)return;this.autoScrollPaging=!1;const e=this.autoScrollRunning={};this.readPage.disableControlPage(),this.container.classList.add("read-page-auto-scroll");const t=t=>{e===this.autoScrollRunning&&window.requestAnimationFrame(t)};new Promise((e,i)=>{const s=[];!function n(r){0===r&&e(),t(()=>{const e=performance.now();s.includes(e)?i():(s.push(e),n(r-1))})}(5)}).then(()=>{var _window$getSelection;e===this.autoScrollRunning&&((_window$getSelection=window.getSelection())!==null&&_window$getSelection!==void 0&&_window$getSelection.empty(),document.addEventListener("visibilitychange",this.autoScrollOnVisibilityChange),this.autoScrollUpdate({reset:!0}),this.autoScrollTick(),document.hidden&&this.autoScrollPause())}).catch(()=>{this.autoScrollStop()})}autoScrollStop({paging:e}={}){null!=this.autoScrollRunning&&(null!=this.autoScrollHandle&&window.cancelAnimationFrame(this.autoScrollHandle),this.autoScrollStartTime=null,this.autoScrollStartPosition=null,this.autoScrollSpeed=null,this.autoScrollHandle=null,this.autoScrollSpeedFactorOld=null,this.autoScrollPaused=null,this.autoScrollRunning=null,document.removeEventListener("visibilitychange",this.autoScrollOnVisibilityChange),e?this.autoScrollPaging=!0:(this.readPage.enableControlPage(),this.container.classList.remove("read-page-auto-scroll"),this.autoScrollPaging=!1))}autoScrollDistance(e){return this.autoScrollPaused?0:((e!==null&&e!==void 0?e:performance.now())-this.autoScrollStartTime)*this.autoScrollSpeed*this.autoScrollSpeedFactor/1e3}autoScrollUpdate({scrollDelta:e=0,speedFactor:t=null,paused:i=null,reset:s=!1,time:n=null}={}){const r=performance.now();if(null==this.autoScrollStartTime||s?this.autoScrollStartPosition=this.lastScrollTop+e:this.autoScrollStartPosition+=this.autoScrollDistance(n!==null&&n!==void 0?n:r)+e,this.autoScrollStartTime=r,null!=this.autoScrollSpeedFactor&&null==t||(this.autoScrollSpeedFactor=Math.max(Math.min(t!==null&&t!==void 0?t:1,this.readSpeedFactorMax),this.readSpeedFactorMin)),null==this.autoScrollSpeed||s){const e=this.readScrollElement.clientWidth-this.textAreaOffset.left-this.textAreaOffset.right,t=Number(this.configs.font_size),i=Number(this.configs.line_height);this.autoScrollSpeed=t**2*i*this.readSpeedBase/e}null!=i&&(this.autoScrollPaused=i)}autoScrollTick(e){this.readPage.isSpeaking()&&this.autoScrollStop();const t=performance.now();if(e&&t-this.autoScrollLastTick>1e3&&this.autoScrollUpdate({now:t}),this.isScrollReachBottom())return this.autoScrollStop(),void this.readPage.showControlPage();this.autoScrollHandle=window.requestAnimationFrame(()=>{const e=this.autoScrollDistance(t);this.readScrollElement.scrollTop=this.autoScrollStartPosition+e,this.autoScrollTick(!0)})}autoScrollPause(){this.autoScrollUpdate({paused:!0})}autoScrollResume(){this.autoScrollUpdate({paused:!1})}autoScrollOnVisibilityChange(){this.autoScrollRunning&&(document.hidden?this.autoScrollPause():this.autoScrollResume())}autoScrollBusy(){return this.autoScrollRunning||this.autoScrollPaging}}const Ee={},Le=Ee,we=[];let ke="dark",Ae=!1,Te=null;const Me=function(){const e="light"===ke||"auto"===ke&&Ae;var t;e!==Te&&(Te=e,t=e,we.forEach(e=>{e(t?"light":"dark")}))},Re=function(e){Ae=e,Me()},Be=window.matchMedia("(prefers-color-scheme: light)");Re(Be.matches),Be.addListener(e=>{Re(e.matches)});const Ie=e=>{ke=e,Me()};u.addListener("theme",Ie),u.get("theme").then(Ie),Ee.getCurrent=function(){return"light"===ke||"auto"===ke&&Ae?"light":"dark"},Ee.addChangeListener=function(e){we.includes(e)||we.push(e)},Ee.removeChangeListener=function(e){const t=we.indexOf(e);-1!==t&&we.splice(t,1)};class Fe{constructor(e,t,i){this.r=e,this.g=t,this.b=i}set(e,t,i){this.r=e,this.g=t,this.b=i}get(){return{r:this.r,g:this.g,b:this.b}}toHex(){return"#"+[..."rgb"].map(e=>Math.round(255*this[e]).toString(16).padStart(2,0)).join("")}static fromHex(e){const t=e.replace(/^#/,""),i=3===t.length?t.replace(/./g,"$&$&"):t,[s,n,r]=i.match(/../g).map(e=>Number.parseInt(e,16)/255);return new Fe(s,n,r)}}class _e{constructor(e){this.container=e,this.onValueChange=[],this.container.classList.add("color-picker"),this.result=this.container.appendChild(document.createElement("div")),this.result.classList.add("color-picker-result"),this.hueBar=this.container.appendChild(document.createElement("div")),this.hueBar.classList.add("color-picker-hue"),this.hueRange=new X(this.hueBar,{min:0,max:360,step:.1}),this.hueRange.onChange(e=>{this.setHSV({hue:e})}),this.hueBar.setAttribute("aria-label",n.getMessage("colorHueRange")),this.saturationBar=this.container.appendChild(document.createElement("div")),this.saturationBar.classList.add("color-picker-saturation"),this.saturationRange=new X(this.saturationBar,{min:0,max:1,step:.001}),this.saturationRange.onChange(e=>{this.setHSV({saturation:e})}),this.saturationBar.setAttribute("aria-label",n.getMessage("colorSaturationRange")),this.valueBar=this.container.appendChild(document.createElement("div")),this.valueBar.classList.add("color-picker-value"),this.valueRange=new X(this.valueBar,{min:0,max:1,step:.001}),this.valueRange.onChange(e=>{this.setHSV({value:e})}),this.valueBar.setAttribute("aria-label",n.getMessage("colorValueRange")),this.candidateList=this.container.appendChild(document.createElement("ul")),this.candidateList.classList.add("color-picker-candidate-list"),this.setHSV({hue:0,saturation:0,value:0}),this.candidateList.addEventListener("click",e=>{const t=e.target;if(!(t instanceof Element))return;const i=t.closest("li");i&&this.setColor(i.dataset.color)})}renderColor(){const e=Math.floor(this.hue%360/60),t=this.hue%60/60,[i,s,n]={0:[1,t,0],1:[1-t,1,0],2:[0,1,t],3:[0,1-t,1],4:[t,0,1],5:[1,0,1-t]}[e];this.hueColor=new Fe(i,s,n),this.container.style.setProperty("--color-picker-hue-color",this.hueColor.toHex());const r=this.value;this.emptySaturationColor=new Fe(r,r,r),this.fullSaturationColor=new Fe(r*i,r*s,r*n),this.container.style.setProperty("--color-picker-empty-saturation",this.emptySaturationColor.toHex()),this.container.style.setProperty("--color-picker-full-saturation",this.fullSaturationColor.toHex());const a=this.saturation,[o,l,h]=[i,s,n].map(e=>1+e*a-a);this.emptyValueColor=new Fe(0,0,0),this.fullValueColor=new Fe(1+i*a-a,1+s*a-a,1+n*a-a),this.container.style.setProperty("--color-picker-empty-value",this.emptyValueColor.toHex()),this.container.style.setProperty("--color-picker-full-value",this.fullValueColor.toHex());const[c,d,u]=[o,l,h].map(e=>e*r);this.color=new Fe(c,d,u),this.container.style.setProperty("--color-picker-color",this.color.toHex()),this.result.setAttribute("aria-label",this.color.toHex())}setHSV({hue:e,saturation:t,value:i}){null!=e&&this.setHue(e),null!=t&&this.setSaturation(t),null!=i&&this.setValue(i),this.renderColor(),this.triggerCallback()}normalizeValue(e,t){const i=Number(e);return Number.isFinite(i)?Math.min(t,Math.max(0,i)):0}setHue(e){this.hue=this.normalizeValue(e,360),this.hueRange.setValue(this.hue)}setSaturation(e){this.saturation=this.normalizeValue(e,1),this.saturationRange.setValue(this.saturation)}setValue(e){this.value=this.normalizeValue(e,1),this.valueRange.setValue(this.value)}onChange(e){this.onValueChange.push(e)}setColor(e){const t=Fe.fromHex(e);if(t.toHex()===this.color.toHex())return;const{r:i,g:s,b:n}=t,[r,a,o]=[i,s,n].sort((e,t)=>e-t);if(o===r)this.setHSV({hue:0,saturation:0,value:o});else{const e=[i>=s&&s>=n,s>=i&&i>=n,s>=n&&n>=i,n>=s&&s>=i,n>=i&&i>=s,i>=n&&n>=s].findIndex(e=>e),t=60*(e+Math.abs((a-r)/(o-r)-e%2)),l=1-r/o,h=o;this.setHSV({hue:t,saturation:l,value:h})}}triggerCallback(){this.hexColor!==this.color.toHex()&&(this.hexColor=this.color.toHex(),this.onValueChange.forEach(e=>{e(this.hexColor)}))}setCandidateList(e){this.candidateList.innerHTML="",e.forEach(e=>{const t=this.candidateList.appendChild(document.createElement("li")),i=t.appendChild(document.createElement("button"));i.type="button",i.title=e,t.dataset.color=e,i.style.background=e})}dispatch(){this.hueRange.dispatch(),this.saturationRange.dispatch(),this.valueRange.dispatch(),this.container.innerHTML=""}}const He=function(e,t){const i=new M(e,{minDistanceX:20,minDistanceY:20});let s=!1,n=null;return i.onStart(([e,t],{touch:i})=>{i&&(e>20||(s=!0,n=null))}),i.onEnd(({touch:i})=>{i&&(s=!1,e.classList.remove("config-page-close-slide"),n>20&&t())}),i.onMoveX((t,{touch:i})=>{if(!i)return;if(!s)return;n=t;const r=t>20?t:0;e.classList.add("config-page-close-slide"),e.style.setProperty("--close-slide-x",r+"px")}),i};class Ve{constructor(e,t){this.container=e,this.page=t;const i=w.create("header");this.container.insertBefore(i.get("root"),this.container.firstChild);const s=w.iconButton("back",n.getMessage("buttonBack"));i.get("left").appendChild(s),this.titleElement=i.get("mid"),this.backButton=s;const r=Ve.index=Ve.index+1||1;this.titleElement.id="config_option_"+r,this.mainContent=e.querySelector(".config-page-content"),this.onConfigValueChange=this.onConfigValueChange.bind(this),this.hide=this.hide.bind(this)}show(){if(this.container.classList.add("config-option-page-show"),this.container.setAttribute("aria-hidden","false"),this.page.configPageMain.setAttribute("aria-hidden","true"),A.disableKeyboardFocus(this.page.configPageMain),this.mainContent.scrollTop=0,this.mainContent.focus(),this.isActive=!0,this.lastFocus=document.activeElement,this.lastFocus.matches("button")){const e=this.mainContent.querySelector('button, [tabindex="0"]');e&&e.focus()}this.touchListener=He(this.container,this.hide)}hide(){this.container.classList.remove("config-option-page-show"),this.container.setAttribute("aria-hidden","true"),this.page.configPageMain.setAttribute("aria-hidden","false"),A.enableKeyboardFocus(this.page.configPageMain),this.isActive=!1,this.lastFocus&&this.lastFocus.focus(),this.touchListener&&(this.touchListener.dispatch(),this.touchListener=null)}onFirstActivate(){this.hide(),this.backButton.addEventListener("click",()=>{this.hide()})}onActivate(){}onInactivate(){}async setConfigOption(e){this.cleanUp(),this.configOption=e,this.titleElement.textContent=e.title,await this.renderOptions();const t=await this.getValue();this.configOption===e&&(this.renderValue(t),u.addListener(e.name,this.onConfigValueChange))}cleanUp(){this.configOption&&(u.removeListener(this.configOption.name,this.onConfigValueChange),this.configOption=null)}renderOptions(){}renderValue(e){}onConfigValueChange(e){this.renderValue(e)}async setValue(e){await this.configOption.setConfig(e)}async getValue(e){return await this.configOption.getConfig(e)}}class De extends Ve{constructor(e,t){super(e,t),this.listElement=this.container.querySelector(".config-option-select-list")}async optionList(){return this.configOption.select.slice(0)}async clearOptions(){this.itemList.clearList()}async renderOptions(){super.renderOptions();const e=this.configOption,t=await this.optionList();e===this.configOption&&(this.itemList=new B(this.listElement,{list:t,onItemClick:e=>{this.setValue(e.value)},render:(e,t)=>{if(e.firstChild)return;const i=e.appendChild(document.createElement("div"));i.classList.add("select-config-option-item"),i.textContent=t.text},selectable:!0,onRemove:this.onItemRemove,mayRemove:this.itemMayRemove,emptyListRender:this.emptyListRender}),this.value=null,this.itemList.listElement.setAttribute("aria-labelby",this.titleElement.id))}cleanUp(){super.cleanUp(),this.itemList&&(this.itemList.dispatch(),this.itemList=null),this.value=null}async renderValue(e){super.renderValue(e);const t=this.configOption,i=await this.optionList();if(t!==this.configOption)return;if(null!=this.value){const e=i.findIndex(e=>e.value===this.value);-1!==e&&this.itemList.setSelectItem(e,!1)}this.value=e;const s=i.findIndex(t=>t.value===e);-1!==s&&this.itemList.setSelectItem(s,!0)}}class Oe extends Ve{constructor(e,t){super(e,t),this.colorPickerElement=this.container.querySelector(".config-option-color-picker"),this.colorPickerElement.setAttribute("aria-labelby",this.titleElement.id)}renderOptions(){super.renderOptions(),this.colorPicker=new _e(this.colorPickerElement),this.colorPicker.onChange(e=>{this.setValue(e)})}cleanUp(){super.cleanUp(),this.colorPicker&&(this.colorPicker.dispatch(),this.colorPicker=null)}renderValue(e){this.colorPicker.setColor(e)}onConfigValueChange(){}}class Ne extends De{constructor(e,t){super(e,t),this.selectFontButton=e.querySelector("#select_font_file"),this.selectFontSectionElement=e.querySelector(".font-select-section"),this.onItemRemove=this.onItemRemove.bind(this),this.itemMayRemove=this.itemMayRemove.bind(this)}onFirstActivate(){super.onFirstActivate(),this.selectFontSection=new B(this.selectFontSectionElement,{list:[null],render:e=>{const t=e.appendChild(document.createElement("div"));t.classList="select-font-button-inner",t.textContent=n.getMessage("configTextFontFamilyUpload")},onItemClick:()=>{this.selectFontButton.click()}}),this.selectFontButton.addEventListener("change",e=>{const t=this.selectFontButton.files[0],i=new FileReader;i.addEventListener("load",async e=>{const s=i.result,r=t.name.replace(/^(.*)\.[^.]*$/,"$1");await this.isValidFont(s)?await this.addFont({name:r,content:s}):alert(n.getMessage("readFontFail")),this.selectFontButton.value=""}),i.readAsDataURL(t)})}async fontList(){const e=await u.get("font_list");return Array.isArray(e)?e:[]}async optionList(){return(await this.fontList()).map(({name:e,id:t})=>({text:e,value:t})).concat([{text:n.getMessage("configTextFontFamilyDefault"),value:0}])}async getValue(){return await super.getValue()||0}async isValidFont(e){const t=document.head.appendChild(document.createElement("style"));t.textContent=`@font-face { font-family: "CustomFontTest"; src: url("${e}"); }`;try{return await document.fonts.load("18px CustomFontTest"),!0}catch(e){return!1}finally{t.remove()}}async addFont(e){let t=await this.fontList();const i=Math.max(0,...t.map(e=>e.id))+1;e.id=i,t.push(e),await u.set("font_list",t),this.itemList.insertItem({text:e.name,value:i},t.length-1),await this.setValue(i)}itemMayRemove(e,t){return e.value>0}async onItemRemove(e,t){const i=e.value,s=await this.fontList(),n=await this.getValue();s[t].id===i?(s.splice(t,1),this.itemList.removeItem(t),await u.set("font_list",s),n===i&&this.setValue(0)):await this.updateRender()}async updateRender(){this.itemList&&(await this.clearOptions(),await this.renderOptions(),await this.renderValue())}}class ze extends De{constructor(e,t){super(e,t),this.voiceList=[],this.preferVoice=null,this.emptyListRender=this.emptyListRender.bind(this)}onFirstActivate(){super.onFirstActivate();const e=()=>{const e=Z.getPreferVoice(),t=Z.getVoiceList();this.updateVoiceList(t,e)};this.updateVoiceList([],null),Promise.all([Z.getVoiceListAsync(),Z.getPreferVoiceAsync()]).then(([t,i])=>{this.updateVoiceList(t,i),Z.onVoiceListChange(e),Z.onPreferVoiceChange(e)}),Z.onVoiceListChange(()=>{e()}),Z.onPreferVoiceChange(e=>{this.updatePrefer(e)})}async updateVoiceList(e,t){this.voiceList=e,this.preferVoice=t,this.itemList&&(this.itemList.setList(await this.optionList()),await this.renderValue(await this.getValue()))}async updatePrefer(e){this.preferVoice=e,this.itemList&&await this.renderValue(await this.getValue())}async optionList(){return this.voiceList.map(e=>({text:`${e.lang} ${e.name}`,value:e.voiceURI}))}async getValue(){return this.preferVoice?this.preferVoice.voiceURI:this.voiceList.length?this.voiceList[0].voiceURI:null}async setConfigOption(e){this.configOption=e,this.titleElement.textContent=e.title,await this.renderOptions();const t=await this.getValue();this.configOption===e&&this.renderValue(t)}cleanUp(){this.configOption=null,this.itemList&&(this.itemList.dispatch(),this.itemList=null)}emptyListRender(e){e.appendChild(document.createElement("div")).textContent=n.getMessage("configSpeechVoiceEmpty")}}class qe extends Ve{constructor(e,t){super(e,t),this.onInput=this.onInput.bind(this)}onFirstActivate(){super.onFirstActivate(),this.inputTitle=this.container.querySelector(".config-option-text-title"),this.input=this.container.querySelector(".config-option-text-input"),this.description=this.container.querySelector(".config-option-text-description"),this.input.addEventListener("input",this.onInput)}async renderOptions(){super.renderOptions();const e=this.configOption;this.inputTitle.textContent=e.label,this.description.textContent=e.description,this.input.value=await this.getValue()}async renderValue(e){}onInput(){this.configOption&&this.setValue(this.input.value)}}class Ue extends Ve{constructor(e,t){super(e,t),this.themeChange=this.themeChange.bind(this)}getUrl(){return new URL("#"+Le.getCurrent(),new URL(this.configOption.url,document.baseURI))}onFirstActivate(){this.iframe=this.container.querySelector("iframe"),this.placeholder=document.createComment(""),this.iframeContainer=this.iframe.parentNode,this.iframeContainer.replaceChild(this.placeholder,this.iframe),super.onFirstActivate(),this.iframe.addEventListener("load",e=>{this.iframe.title=this.iframe.contentDocument.title})}show(){super.show(),this.iframe.src=this.getUrl(),Le.addChangeListener(this.themeChange),this.placeholder.parentNode===this.iframeContainer&&this.iframeContainer.replaceChild(this.iframe,this.placeholder)}hide(){super.hide(),this.iframe.src="about:blank",this.iframe.title=null,Le.removeChangeListener(this.themeChange),this.iframe.parentNode===this.iframeContainer&&this.iframeContainer.replaceChild(this.placeholder,this.iframe)}themeChange(){this.iframe.src=this.getUrl()}}class Ge extends Ve{constructor(e,t){super(e,t),this.onInput=this.onInput.bind(this)}onFirstActivate(){super.onFirstActivate(),this.input=this.container.querySelector(".config-option-expert-input"),this.description=this.container.querySelector(".config-option-expert-description"),this.input.addEventListener("input",this.onInput)}async renderOptions(){super.renderOptions();const e=this.configOption;this.description.textContent=e.description,this.input.value=await this.getValue()}async renderValue(e){}onInput(){this.configOption&&this.setValue(this.input.value)}}me.addListener(([e,t])=>{const i=document.documentElement;i.style.setProperty("--window-width",e+"px"),i.style.setProperty("--window-height",t+"px")});let je=!1;document.documentElement.addEventListener("touchstart",function(e){je=!0},{passive:!0,useCapture:!1}),document.documentElement.addEventListener("mousemove",function(e){je=!1},{passive:!0,useCapture:!1}),document.documentElement.addEventListener("mouseover",function(e){const t=e.target.closest("button");t&&!je&&t.classList.add("hover")},{passive:!0,useCapture:!1}),document.documentElement.addEventListener("mouseout",function(e){const t=e.target.closest("button");t&&t.classList.remove("hover")},{passive:!0,useCapture:!1}),document.body.addEventListener("touchmove",function(e){const t=e.target;if(t instanceof Node)e:do{for(let e=t;e;e=e.parent)if(e instanceof Element){if(e.classList.contains("scroll"))return;if(e.classList.contains("noscroll"))break e}return}while(0);e.preventDefault()},{passive:!1,useCapture:!1}),function(){let e=null;document.addEventListener("touchstart",function(t){e=t.touches.item(0).clientY},{passive:!0}),document.addEventListener("touchmove",function(t){var _document$elementFrom;const i=t.touches.item(0),s=i.clientY,n=(_document$elementFrom=document.elementFromPoint(i.screenX,i.screenY))===null||_document$elementFrom===void 0?void 0:_document$elementFrom.closest(".scroll");if(n){const i=n.scrollTop,r=n.scrollHeight-n.clientHeight;(i<=0&&s>e||i>=r&&s<e)&&t.preventDefault()}e=s},{passive:!1})}(),Array.from(document.querySelectorAll("[data-i18n]")).forEach(e=>{e.textContent=n.getMessage(e.dataset.i18n,...e.children)});const We=function(){const e=document.documentElement,t="light"===Le.getCurrent();e.classList.add(t?"light-theme":"dark-theme"),e.classList.remove(t?"dark-theme":"light-theme")};Le.addChangeListener(We),We(),async function(){const e=await u.expert("appearance.custom_css","string","");document.getElementById("custom_css").textContent=e}();const Ye=new class{constructor(e,t){this.pages=e,this.fallback=t,[...Object.values(this.pages)].forEach(e=>{e.setRouter(this)}),window.addEventListener("hashchange",e=>{this.update()}),document.addEventListener("click",e=>{const t=e.target;if(!(t instanceof Element))return;const i=t.closest("a");if(!i)return;const s=i.hash;new URL(location.hash,i.href).href===location.href&&s&&(this.hashTo(s),e.preventDefault())}),this.initial()}go(e,t){const i=this.pages[e].getUrl(t);return this.hashTo("#!"+i)}async initial(){this.setTitle();const e=await u.get("path")||"#!"+this.fallback;this.hashTo(e)}async update(){this.page=null;const e=location.hash;if(!e.startsWith("#!"))return this.goFallback();const t=e.slice(2),i=[...Object.values(this.pages)],s=i.find(e=>e.matchUrl(t));return s?(i.forEach(e=>{e.isActive()&&e!==s&&e.inactivate()}),await s.activate(s.matchUrl(t)),this.page=s,s):this.goFallback()}goFallback(){const e="#!"+this.fallback;return window.history.replaceState(null,null,e),this.update()}async hashTo(e){window.history.replaceState(null,null,e);const t=await this.update();return t.isPreserve()&&await u.set("path",e),t}setTitle(e,t){document.title=e?n.getMessage("titleWithName",e):n.getMessage("title"),document.head.querySelector("title").lang=t!==null&&t!==void 0?t:n.getMessage("locale")}getCurrentPage(){return this.page}}({list:new class extends m{constructor(){super(document.querySelector("#list_page"))}matchUrl(e){return"/"===e}getUrl(e){return"/"}async onFirstActivate(){const e=w.create("header");this.element.insertBefore(e.get("root"),this.element.firstChild),this.addButton=w.iconButton("add",n.getMessage("buttonAdd")),this.configButton=w.iconButton("settings",n.getMessage("buttonSettings")),e.get("left").appendChild(this.addButton),e.get("right").appendChild(this.configButton),this.fileButton=document.querySelector("#file"),this.fileListContainer=document.querySelector("#file_list_container"),this.fileListElement=document.querySelector("#file_list"),this.searchContainer=this.fileListContainer.querySelector(".list-filter"),this.searchInput=this.searchContainer.querySelector(".list-filter input"),this.searchClearButton=w.iconButton("remove",n.getMessage("listFilterClear")),this.sortButton=this.fileListContainer.querySelector(".list-sort"),this.sortContent=this.fileListContainer.querySelector(".list-sort-content"),this.sortMenu=document.querySelector("#list_sort_menu"),this.importTip=document.querySelector("#import_tip"),this.searchInput.placeholder=n.getMessage("listSearchPlaceholder"),this.searchClearButton.classList.add("list-filter-clear"),this.searchClearButton.disabled=!0,this.searchContainer.appendChild(this.searchClearButton),this.initialListener(),this.options={sortBy:"dateread",search:""}}async onActivate(){this.updateSort(),this.langTag=await u.get("cjk_lang_tag"),await this.updateList()}show(){super.show(),this.scrollToList()}async onInactivate(){this.clearList()}initialListener(){this.addButton.addEventListener("click",e=>{this.fileButton.click()}),this.fileButton.addEventListener("change",async e=>{const t=this.fileButton.files;1===t.length&&await this.importFile(t.item(0)),this.fileButton.value=null}),this.configButton.addEventListener("click",e=>{this.router.go("config")}),this.searchInput.addEventListener("focus",e=>{this.fileListContainer.scrollTop=0}),this.searchInput.addEventListener("input",e=>{this.updateSearch()}),this.searchClearButton.addEventListener("click",e=>{this.clearSearch()}),this.sortMenuKeyboardHandler=this.sortMenuKeyboardHandler.bind(this),this.sortButton.addEventListener("click",e=>{this.showSortMenu()}),this.sortMenu.addEventListener("click",e=>{const t=e.target;if(!(t instanceof Element))return;const i=t.closest(".screen-option-item");if(i){const e=i.dataset.option;e&&(this.options.sortBy=e,this.updateSort(),this.updateList())}this.hideSortMenu()})}async importFile(e){try{this.importTip.style.display="block";const t=await S.readFile(e),i=await S.preprocess(t),s=S.parseFilename(e.name),n=await S.preprocess(s);await v.add({title:n,content:i})}catch(e){alert(n.getMessage("listImportFail"))}this.importTip.style.display="none",this.clearSearch(),this.updateList()}scrollToList(){this.fileListContainer.scrollTop=105}async updateList(){const e=this.lastToken={},t=await v.list();this.searchFiles(t),this.sortFiles(t),e===this.lastToken&&(this.clearList(),this.fileList=new B(this.fileListElement,{list:t.slice(0),render:(e,t)=>{if(e.firstChild)return;const i=w.create("fileListItem"),s=i.get("title");s.textContent=t.title,s.lang=this.langTag;const r=n.getMessage("locale"),a=t.lastAccessTime.toLocaleDateString(r);i.get("date").textContent=a,i.get("date").lang=r,i.get("date").setAttribute("datetime",t.lastAccessTime.toISOString());const o=t.cursor?(t.cursor/t.length*100).toFixed(2)+"%":n.getMessage("listNotYetRead");i.get("detail").textContent=o,e.appendChild(i.get("root"))},onItemClick:e=>{this.router.go("read",{id:e.id})},onRemove:async(e,t)=>{await v.remove(e.id),this.fileList.removeItem(t)},emptyListRender:e=>{const t=e.appendChild(document.createElement("div"));this.options.search?t.textContent=n.getMessage("listEmptySearchTip"):t.textContent=n.getMessage("listEmptyTip")}}))}clearList(){this.fileList&&(this.fileList.dispatch(),this.fileList=null)}updateSearch(){const e=this.searchInput.value.trim();return this.options.search=e,this.searchClearButton.disabled=!e,this.updateList()}clearSearch(){return this.searchInput.value="",this.updateSearch()}updateSort(){const e=[...document.querySelectorAll(".list-sort-menu [data-option]")].find(e=>e.dataset.option===this.options.sortBy);this.sortContent.querySelector("span").textContent=e.textContent}searchFiles(e){for(let t=0;t<e.length;)e[t].title.includes(this.options.search)?t++:e.splice(t,1)}sortFiles(e){const t={dateread:(e,t)=>t.lastAccessTime-e.lastAccessTime,dateadd:(e,t)=>t.createTime-e.createTime,title:(e,t)=>e.title.localeCompare(t.title,navigator.language)}[this.options.sortBy];e.sort(t)}sortMenuKeyboardHandler(e){"Escape"===e.code&&this.hideSortMenu()}showSortMenu(){if(this.sortMenu.style.display="block",this.element.setAttribute("aria-hidden","true"),A.disableKeyboardFocus(this.element),document.addEventListener("keydown",this.sortMenuKeyboardHandler),document.activeElement===this.sortButton&&this.sortMenu.querySelector("button").focus(),this.sortMenuActiveElementBefore=document.activeElement,document.activeElement.matches("button")){const e=this.sortMenu.querySelectorAll(".screen-option-item");Array.from(e).pop().focus()}}hideSortMenu(){this.sortMenu.style.display="none",this.element.setAttribute("aria-hidden","false"),A.enableKeyboardFocus(this.element),document.removeEventListener("keydown",this.sortMenuKeyboardHandler),this.sortMenuActiveElementBefore.focus(),this.sortMenuActiveElementBefore=null}},read:new class extends m{constructor(){super(document.querySelector("#read_page")),this.useSideIndex=null,this.onResize=this.onResize.bind(this),this.keyboardEvents=this.keyboardEvents.bind(this)}matchUrl(e){if(!/\/read\/\d+/.test(e))return null;const t=+e.split("/").pop();return t?{id:t}:null}getUrl({id:e}){return"/read/"+e}async onFirstActivate(){this.container=document.querySelector("#read_page"),this.controlPageElement=this.container.querySelector(".read-control"),this.controlPage=new ge(this.controlPageElement,this),this.indexPageElement=this.container.querySelector(".read-index"),this.indexPage=new Y(this.indexPageElement,this),this.jumpPageElement=this.container.querySelector(".read-jump"),this.jumpPage=new $(this.jumpPageElement,this),this.speech=new ue(this),this.subPages=[this.controlPage,this.indexPage,this.jumpPage],this.subPages.forEach(e=>{e.onFirstActivate()}),this.container.addEventListener("scroll",e=>{this.container.scrollTop=0,this.container.scrollLeft=0,e.preventDefault()})}async onActivate({id:e}){this.langTag=await u.get("cjk_lang_tag"),this.renderStyle=await u.get("view_mode"),this.screenWidthSideIndex=await u.expert("appearance.screen_width_side_index","number",960),this.articleId=e;const[t,i,s]=await Promise.all([v.getMeta(e),v.getIndex(e),v.content(e)]);this.meta=t,this.content=s,this.index=i,this.meta&&this.content?(await v.setMeta(this.meta),await this.speech.init(),this.speech.metaLoad(this.meta),this.readIndex=new K(this),"flip"===this.renderStyle?(this.textPage=new ye(this),this.container.classList.add("read-page-flip")):(this.textPage=new Pe(this),this.container.classList.add("read-page-scroll")),await this.textPage.onActivate({id:e}),me.addListener(this.onResize),document.addEventListener("keydown",this.keyboardEvents),this.router.setTitle(this.meta.title,this.getLang()),this.subPages.forEach(e=>{e.onActivate()}),this.updateSideIndex()):this.gotoList()}async onUpdate({id:e}){this.onInactivate(),this.onActivate({id:e})}async onInactivate(){this.meta=null,this.index=null,this.content=null,this.pages=null,this.readIndex=null,this.useSideIndex=null,document.removeEventListener("keydown",this.keyboardEvents),this.subPages.forEach(e=>{e.onInactivate()}),this.speech.stop(),this.speech.metaUnload(),this.textPage.onInactivate(),this.textPage=null,this.container.classList.remove("read-page-scroll","read-page-flip"),this.router.setTitle()}gotoList(){this.router.go("list")}show(){super.show(),this.textPage.initUpdatePage()}onResize(){this.updateSideIndex()}keyboardEvents(e){if("Escape"===e.code){const e=this.activedSubpage();e?e.hide():this.controlPage.hasFocus?this.controlPage.hide():this.controlPage.focus()}}updateIndexRender(e=this.useSideIndex){const t=this.isIndexActive();t?this.container.classList.add("read-show-index"):this.container.classList.remove("read-show-index"),t&&!this.useSideIndex?(this.controlPage.disable(),this.textPage.hide()):(this.controlPage.enable(),this.textPage.show()),e&&(window.requestAnimationFrame(()=>{this.onResize()}),this.textPage.onResize())}updateSideIndex(){const[e,t]=me.currentSize(),i=e>=this.screenWidthSideIndex;i!==this.useSideIndex&&(this.useSideIndex=i,i?(this.container.classList.add("read-page-wide"),this.container.classList.remove("read-page-thin")):(this.container.classList.remove("read-page-wide"),this.container.classList.add("read-page-thin")),this.isIndexActive()&&this.updateIndexRender(!0))}isIndexActive(){var _this$indexPage;return(_this$indexPage=this.indexPage)===null||_this$indexPage===void 0?void 0:_this$indexPage.isCurrent}isSideIndexActive(){return this.useSideIndex&&this.indexPage.isCurrent}slideIndexPage(e,t){this.indexPage.slideShow(e,t)}toggleIndexPage(e){this.isIndexActive()&&this.indexPage.isSubPageCurrent(e)?this.indexPage.hide():this.indexPage.show(e)}isControlActive(){return this.controlPage.isShow}disableControlPage(){this.controlPage.hide(),this.controlPage.disable()}enableControlPage(){this.controlPage.enable()}showControlPage(e){e?this.controlPage.focus():this.controlPage.show()}hideControlPage(){this.controlPage.hide()}toggleControlPage(){this.controlPage.isShow?this.controlPage.hide():this.controlPage.show()}isJumpActive(){return this.jumpPage.isCurrent}showJumpPage(){return this.jumpPage.show()}activedSubpage(){return this.isIndexActive()?this.indexPage:this.isControlActive()?this.controlPage:this.isJumpActive()?this.jumpPage:null}toggleSpeech(){return this.speech.toggle()}getRawCursor(){return this.meta.cursor}getRenderCursor(){return this.textPage.getRenderCursor()}setCursor(e,t){this.meta.cursor!==e&&(this.meta.cursor=e,v.setMeta(this.meta),this.textPage.cursorChange(e,t),this.subPages.forEach(i=>i.cursorChange(e,t)),this.speech.cursorChange(e,t))}getContent(){return this.content}getMeta(){return this.meta}getLang(){return this.langTag}isSpeaking(){return this.speech.isWorking()}getBookmarks(){return this.index.bookmarks}getContents(){return this.index.content}},config:new class extends m{constructor(){const e=document.getElementById("config_page");super(e),this.configPage=e,this.configPageMain=e.querySelector(".config-page-main"),this.addHeader(),this.configPageMainContent=this.configPageMain.querySelector(".config-page-content"),this.selectConfigPageElement=document.getElementById("config_page_select"),this.selectConfigPage=new De(this.selectConfigPageElement,this),this.colorConfigPageElement=document.getElementById("config_page_color"),this.colorConfigPage=new Oe(this.colorConfigPageElement,this),this.fontConfigPageElement=document.getElementById("config_page_font"),this.fontConfigPage=new Ne(this.fontConfigPageElement,this),this.voiceConfigPageElement=document.getElementById("config_page_voice"),this.voiceConfigPage=new ze(this.voiceConfigPageElement,this),this.textConfigPageElement=document.getElementById("config_page_text"),this.textConfigPage=new qe(this.textConfigPageElement,this),this.webpageConfigPageElement=document.getElementById("config_page_webpage"),this.webpageConfigPage=new Ue(this.webpageConfigPageElement,this),this.expertConfigPageElement=document.getElementById("config_page_expert"),this.expertConfigPage=new Ge(this.expertConfigPageElement,this),this.subConfigPages=[this.selectConfigPage,this.colorConfigPage,this.fontConfigPage,this.voiceConfigPage,this.textConfigPage,this.webpageConfigPage,this.expertConfigPage],this.activeSubConfigPage=null,this.keyboardHandler=this.keyboardHandler.bind(this)}addHeader(){const e=this.configPageMain,t=w.create("header");e.insertBefore(t.get("root"),e.firstChild);const i=w.iconButton("back",n.getMessage("buttonBack"));t.get("left").appendChild(i),t.get("mid").textContent=n.getMessage("configPageTitle"),this.gotoList=this.gotoList.bind(this),i.addEventListener("click",()=>{this.gotoList()})}matchUrl(e){return/^\/settings(\/.*)?$/.test(e)}getUrl(e){return e?`/settings/${e}`:"/settings"}async onFirstActivate(){const e=this.configPageMainContent,t=(e,t)=>{t.setup(e)},i=async e=>{let t=null;"select"===e.type&&(t=this.selectConfigPage),"color"===e.type&&(t=this.colorConfigPage),"font"===e.type&&(t=this.fontConfigPage),"voice"===e.type&&(t=this.voiceConfigPage),"text"===e.type&&(t=this.textConfigPage),"webpage"===e.type&&(t=this.webpageConfigPage),"expert"===e.type&&(t=this.expertConfigPage),this.activeSubConfigPage&&this.activeSubConfigPage.cleanUp(),this.activeSubConfigPage=t,t&&(await t.setConfigOption(e),t.show())};z.forEach(s=>{const n=e.appendChild(document.createElement("div"));n.classList.add("config-title"),n.setAttribute("role","heading"),n.textContent=s.title;const r=e.appendChild(document.createElement("div"));r.classList.add("config-group"),new B(r,{list:s.items,onItemClick:i,render:t})}),this.subConfigPages.forEach(e=>{e.onFirstActivate()})}async onActivate(){document.addEventListener("keydown",this.keyboardHandler),this.touchListener=He(this.configPageMain,this.gotoList)}async onInactivate(){this.subConfigPages.forEach(e=>{e.onInactivate()}),document.removeEventListener("keydown",this.keyboardHandler),this.touchListener&&this.touchListener.dispatch()}isPreserve(){return!1}keyboardHandler(e){if("Escape"===e.code){const t=this.subConfigPages.find(e=>e.isActive);t?t.hide():this.gotoList(),e.preventDefault()}}gotoList(){this.router.go("list")}}},"/");window.addEventListener("load",()=>{(async function(){!1!==navigator.onLine&&"serviceWorker"in navigator&&await navigator.serviceWorker.register("./sw.js")})().catch(()=>{})}),"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",async e=>{"import"===e.data.action&&(await Ye.go("list")).importFile(e.data.file)})})();
